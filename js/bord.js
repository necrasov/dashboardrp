// Данные для диаграммы доходов
const financialData = {
  years: ['2024', '2025', '2026', '2027'],
  incomes: [1060713.7, 1093696.10, 1040730.6, 1198848.1]
};
// Данные для расходов
const expensesData = {
  years: ['2024', '2025', '2026', '2027'],
  expenses: [1052538.90, 1159042.30, 1040730.60, 1198848.1]
};
// Цвета для проектов
const projectColors = [
  '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
  '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
  '#aec7e8', '#ffbb78', '#98df8a', '#ff9896', '#c5b0d5',
  '#c49c94', '#f7b6d2', '#c7c7c7', '#dbdb8d', '#9edae5',
  '#393b79', '#637939', '#8c6d31', '#843c39', '#7b4173',
  '#5254a3', '#6b4c7d', '#a55194', '#ce6dbd', '#de9ed6',
  '#3182bd', '#e6550d', '#31a354', '#756bb1', '#636363',
  '#9ecae1', '#fdae6b', '#a1d99b', '#c6dbef', '#fdd0a2',
  '#ad494a', '#8c6bb1', '#08519c', '#a50f15', '#4a1486',
  '#006d2c', '#993404', '#4d004b', '#01665e', '#542788',
  '#80cdc1', '#bf812d', '#8c510a', '#d8b365', '#f5f5f5',
  '#808080', '#4d4d4d', '#b3b3b3'
];
// ДОХОДЫ
const projectsData = {
  2024: [
    {
      id: 1,
      name: 'Налоговые доходы',
      amount: 270674.6,
      selected: true,
      color: projectColors[0],
      subProjects: [
        { id: 11, name: 'Налог на доходы физических лиц', amount: 222434.9, selected: true },
        { id: 12, name: 'Налоги на совокупный доход', amount: 40544.6, selected: true },
        { id: 13, name: 'Налоги, сборы и регулярные платежи за пользование природными ресурсами', amount: 266.8, selected: true },
        { id: 14, name: 'Государственная пошлина', amount: 7428.3, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Неналоговые доходы',
      amount: 24769.7,
      selected: true,
      color: projectColors[1],
      subProjects: [
        { id: 21, name: 'Доходы от использования имущества, находящегося в государственной и муниципальной собственности', amount: 18248.8, selected: true },
        { id: 22, name: 'Платежи при пользовании природными ресурсами', amount: 950.3, selected: true },
        { id: 23, name: 'Доходы от оказания платных услуг (работ) и компенсации затрат государства', amount: 334.7, selected: true },
        { id: 24, name: 'Доходы от продажи материальных и нематериальных активов', amount: 4021.1, selected: true },
        { id: 25, name: 'Штрафы', amount: 1214.8, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Дотации бюджетам бюджетной системы Федерации',
      amount: 125288.50,
      selected: true,
      color: projectColors[2],
      subProjects: [
        { id: 31, name: 'Дотации бюджетам муниципальных районов на выравнивание бюджетной обеспеченности из бюджета субъекта Российской Федерации', amount: 124447, selected: true },
        { id: 32, name: 'Прочие дотации бюджетам муниципальных районов', amount: 841.5, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Субсидии',
      amount: 65319.30,
      selected: true,
      color: projectColors[3],
      subProjects: [
        { id: 41, name: 'Субсидии бюджетам муниципальных районов на создание в общеобразовательных организациях, расположенных в сельской местности, условий для занятий физической культурой и спортом', amount: 258.6, selected: true },
        { id: 42, name: 'Субсидии бюджетам муниципальных районов на проведение мероприятий по обеспечению деятельности советников директора по воспитанию и взаимодействию с детскими общественными объединениями в общеобразовательных организациях', amount: 2167.5, selected: true },
        { id: 43, name: 'Субсидии бюджетам муниципальных районов на организацию бесплатного горячего питания обучающихся, получающих начальное общее образование в государственных и муниципальных образовательных организации', amount: 11931.5, selected: true },
        { id: 44, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по обеспечению жильем молодых семей', amount: 8856.3, selected: true },
        { id: 45, name: 'Субсидии бюджетам муниципальных районов на поддержку отрасли культуры', amount: 0, selected: true },
        { id: 46, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по модернизации школьных систем образования', amount: 0, selected: true },
        { id: 47, name: 'Прочие субсидии', amount: 42105.4, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Субвенции',
      amount: 530035.80,
      selected: true,
      color: projectColors[4],
      subProjects: [
        { id: 51, name: 'Субвенции бюджетам муниципальных районов на выполнение передаваемых полномочий субъектов Российской Федерации', amount: 459933, selected: true },
        { id: 52, name: 'Субвенции бюджетам муниципальных районов на компенсацию части платы, взимаемой с родителей (законных представителей) за присмотр и уход за детьми, посещающими образовательные организации, реализующие образовательные программы дошкольного образования', amount: 2426.8, selected: true },
        { id: 53, name: 'Субвенции бюджетам муниципальных районов на предоставление жилых помещений детям-сиротам и детям, оставшимся без попечения родителей, лицам из их числа по договорам найма специализированных жилых помещений', amount: 2175.5, selected: true },
        { id: 54, name: 'Субвенции бюджетам муниципальных районов на осуществление полномочий по составлению (изменению) списков кандидатов в присяжные заседатели федеральных судов общей юрисдикции в Российской Федерации', amount: 0, selected: true },
        { id: 55, name: 'Субвенции бюджетам муниципальных районов на государственную регистрацию актов гражданского состояния', amount: 1148.8, selected: true },
        { id: 56, name: 'Единая субвенция бюджетам муниципальных районов', amount: 2726.7, selected: true },
        { id: 57, name: 'Прочие субвенции бюджетам муниципальных районов', amount: 61625, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Межбюджетные трансферты',
      amount: 44720.9,
      selected: true,
      color: projectColors[5],
      subProjects: [
        { id: 61, name: 'Межбюджетные трансферты, передаваемемые бюджетам муниципальных образований на осуществление части полномочий по решению вопросов местного значения в соответствии с заключенными соглашениями', amount: 10793, selected: true },
        { id: 62, name: 'Межбюджетные трансферты, передаваемые бюджетам на обеспечение выплат ежемесячного денежного вознаграждения советникам директоров по воспитанию и взаимодействию с детскими общественными объединениями государственных общеобразовательных организаций, профессиональных образовательных организаций субъектов Российской Федерации, г. Байконура и федеральной территории "Сириус", муниципальных общеобразовательных организаций и профессиональных образовательных организаций', amount: 239.6, selected: true },
        { id: 63, name: 'Межбюджетные трансферты бюджетам муниципальных районов на ежемесячное денежное вознаграждение за классное руководство педагогическим работникам государственных и муниципальных общеобразовательных организаций', amount: 32588.3, selected: true },
        { id: 64, name: 'Прочие межбюджетные трансферты, передаваемые бюджетам муниципальных районов', amount: 1100, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Возврат прочих остатков',
      amount: -95.1,
      selected: true,
      color: projectColors[6],
      subProjects: []
    }
  ],
  2025: [
    {
      id: 1,
      name: 'Налоговые доходы',
      amount: 299582.9,
      selected: true,
      color: projectColors[7],
      subProjects: [
        { id: 11, name: 'Налог на доходы физических лиц', amount: 240904.9, selected: true },
        { id: 12, name: 'Налоги на совокупный доход', amount: 46373, selected: true },
        { id: 13, name: 'Налоги, сборы и регулярные платежи за пользование природными ресурсами', amount: 116, selected: true },
        { id: 14, name: 'Государственная пошлина', amount: 12189, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Неналоговые доходы',
      amount: 17134.8,
      selected: true,
      color: projectColors[8],
      subProjects: [
        { id: 21, name: 'Доходы от использования имущества, находящегося в государственной и муниципальной собственности', amount: 14647.1, selected: true },
        { id: 22, name: 'Платежи при пользовании природными ресурсами', amount: 1300.7, selected: true },
        { id: 23, name: 'Доходы от оказания платных услуг (работ) и компенсации затрат государства', amount: 0, selected: true },
        { id: 24, name: 'Доходы от продажи материальных и нематериальных активов', amount: 200, selected: true },
        { id: 25, name: 'Штрафы', amount: 987, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Дотации бюджетам бюджетной системы Федерации',
      amount: 131619.00,
      selected: true,
      color: projectColors[9],
      subProjects: [
        { id: 31, name: 'Дотации бюджетам муниципальных районов на выравнивание бюджетной обеспеченности из бюджета субъекта Российской Федерации', amount: 128619.00, selected: true },
        { id: 32, name: 'Прочие дотации бюджетам муниципальных районов', amount: 3000.00, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Субсидии',
      amount: 31567.10,
      selected: true,
      color: projectColors[10],
      subProjects: [
        { id: 41, name: 'Субсидии бюджетам муниципальных районов на создание в общеобразовательных организациях, расположенных в сельской местности, условий для занятий физической культурой и спортом', amount: 0, selected: true },
        { id: 42, name: 'Субсидии бюджетам муниципальных районов на проведение мероприятий по обеспечению деятельности советников директора по воспитанию и взаимодействию с детскими общественными объединениями в общеобразовательных организациях', amount: 2174.40, selected: true },
        { id: 43, name: 'Субсидии бюджетам муниципальных районов на организацию бесплатного горячего питания обучающихся, получающих начальное общее образование в государственных и муниципальных образовательных организациях', amount: 15236.70, selected: true },
        { id: 44, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по обеспечению жильем молодых семей', amount: 4505.30, selected: true },
        { id: 45, name: 'Субсидии бюджетам муниципальных районов на поддержку отрасли культуры', amount: 0, selected: true },
        { id: 46, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по модернизации школьных систем образования', amount: 0, selected: true },
        { id: 47, name: 'Прочие субсидии', amount: 9650.70, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Субвенции',
      amount: 564376.50,
      selected: true,
      color: projectColors[11],
      subProjects: [
        { id: 51, name: 'Субвенции бюджетам муниципальных районов на выполнение передаваемых полномочий субъектов Российской Федерации', amount: 488593.10, selected: true },
        { id: 52, name: 'Субвенции бюджетам муниципальных районов на компенсацию части платы, взимаемой с родителей (законных представителей) за присмотр и уход за детьми, посещающими образовательные организации, реализующие образовательные программы дошкольного образования', amount: 4122.50, selected: true },
        { id: 53, name: 'Субвенции бюджетам муниципальных районов на предоставление жилых помещений детям-сиротам и детям, оставшимся без попечения родителей, лицам из их числа по договорам найма специализированных жилых помещений', amount: 1112.30, selected: true },
        { id: 54, name: 'Субвенции бюджетам муниципальных районов на осуществление полномочий по составлению (изменению) списков кандидатов в присяжные заседатели федеральных судов общей юрисдикции в Российской Федерации', amount: 3.00, selected: true },
        { id: 55, name: 'Субвенции бюджетам муниципальных районов на государственную регистрацию актов гражданского состояния', amount: 1715.60, selected: true },
        { id: 56, name: 'Единая субвенция бюджетам муниципальных районов', amount: 4766.10, selected: true },
        { id: 57, name: 'Прочие субвенции бюджетам муниципальных районов', amount: 64064.00, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Межбюджетные трансферты',
      amount: 49415.70,
      selected: true,
      color: projectColors[12],
      subProjects: [
        { id: 61, name: 'Межбюджетные трансферты, передаваемые бюджетам муниципальных образований на осуществление части полномочий по решению вопросов местного значения в соответствии с заключенными соглашениями', amount: 11144.70, selected: true },
        { id: 62, name: 'Межбюджетные трансферты, передаваемые бюджетам на обеспечение выплат ежемесячного денежного вознаграждения советникам директоров по воспитанию и взаимодействию с детскими общественными объединениями государственных общеобразовательных организаций, профессиональных образовательных организаций субъектов Российской Федерации, г. Байконура и федеральной территории "Сириус", муниципальных общеобразовательных организаций и профессиональных образовательных организаций', amount: 718.70, selected: true },
        { id: 63, name: 'Межбюджетные трансферты бюджетам муниципальных районов на ежемесячное денежное вознаграждение за классное руководство педагогическим работникам государственных и муниципальных общеобразовательных организаций', amount: 37552.30, selected: true },
        { id: 64, name: 'Прочие межбюджетные трансферты, передаваемые бюджетам муниципальных районов', amount: 0, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Возврат прочих остатков',
      amount: 0,
      selected: true,
      color: projectColors[13],
      subProjects: []
    }
  ],
  2026: [
    {
      id: 1,
      name: 'Налоговые доходы',
      amount: 321794.3,
      selected: true,
      color: projectColors[14],
      subProjects: [
        { id: 11, name: 'Налог на доходы физических лиц', amount: 261316.9, selected: true },
        { id: 12, name: 'Налоги на совокупный доход', amount: 48172.4, selected: true },
        { id: 13, name: 'Налоги, сборы и регулярные платежи за пользование природными ресурсами', amount: 116, selected: true },
        { id: 14, name: 'Государственная пошлина', amount: 12189, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Неналоговые доходы',
      amount: 16916.3,
      selected: true,
      color: projectColors[15],
      subProjects: [
        { id: 21, name: 'Доходы от использования имущества, находящегося в государственной и муниципальной собственности', amount: 14428.6, selected: true },
        { id: 22, name: 'Платежи при пользовании природными ресурсами', amount: 1300.7, selected: true },
        { id: 23, name: 'Доходы от оказания платных услуг (работ) и компенсации затрат государства', amount: 0, selected: true },
        { id: 24, name: 'Доходы от продажи материальных и нематериальных активов', amount: 200, selected: true },
        { id: 25, name: 'Штрафы', amount: 987, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Дотации бюджетам бюджетной системы Федерации',
      amount: 76859.00,
      selected: true,
      color: projectColors[16],
      subProjects: [
        { id: 31, name: 'Дотации бюджетам муниципальных районов на выравнивание бюджетной обеспеченности из бюджета субъекта Российской Федерации', amount: 76859.00, selected: true },
        { id: 32, name: 'Прочие дотации бюджетам муниципальных районов', amount: 0, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Субсидии',
      amount: 41073.10,
      selected: true,
      color: projectColors[17],
      subProjects: [
        { id: 41, name: 'Субсидии бюджетам муниципальных районов на создание в общеобразовательных организации, расположенных в сельской местности, условий для занятий физической культурой и спортом', amount: 0, selected: true },
        { id: 42, name: 'Субсидии бюджетам муниципальных районов на проведение мероприятий по обеспечению деятельности советников директора по воспитанию и взаимодействию с детскими общественными объединениями в общеобразовательных организациях', amount: 2190.40, selected: true },
        { id: 43, name: 'Субсидии бюджетам муниципальных районов на организацию бесплатного горячего питания обучающихся, получающих начальное общее образование в государственных и муниципальных образовательных организациях', amount: 14437.00, selected: true },
        { id: 44, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по обеспечению жильем молодых семей', amount: 4445.80, selected: true },
        { id: 45, name: 'Субсидии бюджетам муниципальных районов на поддержку отрасли культуры', amount: 349.20, selected: true },
        { id: 46, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по модернизации школьных систем образования', amount: 0, selected: true },
        { id: 47, name: 'Прочие субсидии', amount: 19650.70, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Субвенции',
      amount: 545816.90,
      selected: true,
      color: projectColors[18],
      subProjects: [
        { id: 51, name: 'Субвенции бюджетам муниципальных районов на выполнение передаваемых полномочий субъектов Российской Федерации', amount: 491323.60, selected: true },
        { id: 52, name: 'Субвенции бюджетам муниципальных районов на компенсацию части платы, взимаемой с родителей (законных представителей) за присмотр и уход за детьми, посещающими образовательные организации, реализующие образовательные программы дошкольного образования', amount: 4122.50, selected: true },
        { id: 53, name: 'Субвенции бюджетам муниципальных районов на предоставление жилых помещений детям-сиротам и детям, оставшимся без попечения родителей, лицам из их числа по договорам найма специализированных жилых помещений', amount: 1344.50, selected: true },
        { id: 54, name: 'Субвенции бюджетам муниципальных районов на осуществление полномочий по составлению (изменению) списков кандидатов в присяжные заседатели федеральных судов общей юрисдикции в Российской Федерации', amount: 115.50, selected: true },
        { id: 55, name: 'Субвенции бюджетам муниципальных районов на государственную регистрацию актов гражданского состояния', amount: 1761.70, selected: true },
        { id: 56, name: 'Единая субвенция бюджетам муниципальных районов', amount: 4702.10, selected: true },
        { id: 57, name: 'Прочие субвенции бюджетам муниципальных районов', amount: 42447.00, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Межбюджетные трансферты',
      amount: 38271.00,
      selected: true,
      color: projectColors[19],
      subProjects: [
        { id: 61, name: 'Межбюджетные трансферты, передаваемые бюджетам муниципальных образований на осуществление части полномочий по решению вопросов местного значения в соответствии с заключенными соглашениями', amount: 0.00, selected: true },
        { id: 62, name: 'Межбюджетные трансферты, передаваемые бюджетам на обеспечение выплат ежемесячного денежного вознаграждения советникам директоров по воспитанию и взаимодействию с детскими общественными объединениями государственных общеобразовательных организаций, профессиональных образовательных организаций субъектов Российской Федерации, г. Байконура и федеральной территории "Сириус", муниципальных общеобразовательных организаций и профессиональных образовательных организаций', amount: 718.70, selected: true },
        { id: 63, name: 'Межбюджетные трансферты бюджетам муниципальных районов на ежемесячное денежное вознаграждение за классное руководство педагогическим работникам государственных и муниципальных общеобразовательных организаций', amount: 37552.30, selected: true },
        { id: 64, name: 'Прочие межбюджетные трансферты, передаваемые бюджетам муниципальных районов', amount: 0, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Возврат прочих остатков',
      amount: 0,
      selected: true,
      color: projectColors[20],
      subProjects: []
    }
  ],
  2027: [
    {
      id: 1,
      name: 'Налоговые доходы',
      amount: 337881.1,
      selected: true,
      color: projectColors[21],
      subProjects: [
        { id: 11, name: 'Налог на доходы физических лиц', amount: 275610.5, selected: true },
        { id: 12, name: 'Налоги на совокупный доход', amount: 49971.6, selected: true },
        { id: 13, name: 'Налоги, сборы и регулярные платежи за пользование природными ресурсами', amount: 116, selected: true },
        { id: 14, name: 'Государственная пошлина', amount: 12189, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Неналоговые доходы',
      amount: 16841.4,
      selected: true,
      color: projectColors[22],
      subProjects: [
        { id: 21, name: 'Доходы от использования имущества, находящегося в государственной и муниципальной собственности', amount: 14353.7, selected: true },
        { id: 22, name: 'Платежи при пользовании природными ресурсами', amount: 1300.7, selected: true },
        { id: 23, name: 'Доходы от оказания платных услуг (работ) и компенсации затрат государства', amount: 0, selected: true },
        { id: 24, name: 'Доходы от продажи материальных и нематериальных активов', amount: 200, selected: true },
        { id: 25, name: 'Штрафы', amount: 987, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Дотации бюджетам бюджетной системы Федерации',
      amount: 73422.00,
      selected: true,
      color: projectColors[23],
      subProjects: [
        { id: 31, name: 'Дотации бюджетам муниципальных районов на выравнивание бюджетной обеспеченности из бюджета субъекта Российской Федерации', amount: 73422.00, selected: true },
        { id: 32, name: 'Прочие дотации бюджетам муниципальных районов', amount: 0.00, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Субсидии',
      amount: 188704.20,
      selected: true,
      color: projectColors[24],
      subProjects: [
        { id: 41, name: 'Субсидии бюджетам муниципальных районов на создание в общеобразовательных организациях, расположенных в сельской местности, условий для занятий физической культурой и спортом', amount: 0, selected: true },
        { id: 42, name: 'Субсидии бюджетам муниципальных районов на проведение мероприятий по обеспечению деятельности советников директора по воспитанию и взаимодействию с детскими общественными объединениями в общеобразовательных организациях', amount: 2190.40, selected: true },
        { id: 43, name: 'Субсидии бюджетам муниципальных районов на организацию бесплатного горячего питания обучающихся, получающих начальное общее образование в государственных и муниципальных образовательных организациях', amount: 14232.80, selected: true },
        { id: 44, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по обеспечению жильем молодых семей', amount: 4452.60, selected: true },
        { id: 45, name: 'Субсидии бюджетам муниципальных районов на поддержку отрасли культуры', amount: 0.00, selected: true },
        { id: 46, name: 'Субсидии бюджетам муниципальных районов на реализацию мероприятий по модернизации школьных систем образования', amount: 138633.70, selected: true },
        { id: 47, name: 'Прочие субсидии', amount: 29194.70, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Субвенции',
      amount: 543722.40,
      selected: true,
      color: projectColors[25],
      subProjects: [
        { id: 51, name: 'Субвенции бюджетам муниципальных районов на выполнение передаваемых полномочий субъектов Российской Федерации', amount: 491675.70, selected: true },
        { id: 52, name: 'Субвенции бюджетам муниципальных районов на компенсацию части платы, взимаемой с родителей (законных представителей) за присмотр и уход за детьми, посещающими образовательные организации, реализующие образовательные программы дошкольного образования', amount: 4122.5, selected: true },
        { id: 53, name: 'Субвенции бюджетам муниципальных районов на предоставление жилых помещений детям-сиротам и детям, оставшимся без попечения родителей, лицам из их числа по договорам найма специализированных жилых помещений', amount: 1367.40, selected: true },
        { id: 54, name: 'Субвенции бюджетам муниципальных районов на осуществление полномочий по составлению (изменению) списков кандидатов в присяжные заседатели федеральных судов общей юрисдикции в Российской Федерации', amount: 0.00, selected: true },
        { id: 55, name: 'Субвенции бюджетам муниципальных районов на государственную регистрацию актов гражданского состояния', amount: 1761.70, selected: true },
        { id: 56, name: 'Единая субвенция бюджетам муниципальных районов', amount: 4700.10, selected: true },
        { id: 57, name: 'Прочие субвенции бюджетам муниципальных районов', amount: 40095.00, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Межбюджетные трансферты',
      amount: 38271.00,
      selected: true,
      color: projectColors[26],
      subProjects: [
        { id: 61, name: 'Межбюджетные трансферты, передаваемые бюджетам муниципальных образований на осуществление части полномочий по решению вопросов местного значения в соответствии с заключенными соглашениями', amount: 0.00, selected: true },
        { id: 62, name: 'Межбюджетные трансферты, передаваемемые бюджетам на обеспечение выплат ежемесячного денежного вознаграждения советникам директоров по воспитанию и взаимодействию с детскими общественными объединениями государственных общеобразовательных организаций, профессиональных образовательных организаций субъектов Российской Федерации, г. Байконура и федеральной территории "Сириус", муниципальных общеобразовательных организаций и профессиональных образовательных организаций', amount: 718.70, selected: true },
        { id: 63, name: 'Межбюджетные трансферты бюджетам муниципальных районов на ежемесячное денежное вознаграждение за классное руководство педагогическим работникам государственных и муниципальных общеобразовательных организаций', amount: 37552.30, selected: true },
        { id: 64, name: 'Прочие межбюджетные трансферты, передаваемые бюджетам муниципальных районов', amount: 0, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Возврат прочих остатков',
      amount: 0,
      selected: true,
      color: projectColors[27],
      subProjects: []
    }
  ]
};
// РАСХОДЫ
const expensesItemsData = {
  2024: [
    {
      id: 1,
      name: 'Общегосударственные вопросы',
      amount: 97439.40,
      selected: true,
      color: projectColors[0],
      subProjects: [
        { id: 11, name: 'Функционирование высшего должностного лица субъекта Российской Федерации и муниципального образования', amount: 2615.3, selected: true },
        { id: 12, name: 'Функционирование законодательных (представительных) органов государственной власти и представительных органов муниципальных образований', amount: 1029.8, selected: true },
        { id: 13, name: 'Функционирование Правительства Российской Федерации, высших исполнительных органов субъектов Российской Федерации, местных администраций', amount: 27175.4, selected: true },
        { id: 14, name: 'Судебная система', amount: 0, selected: true },
        { id: 15, name: 'Обеспечение деятельности финансовых, налоговых и таможенных органов и органов финансового (финансово-бюджетного) надзора', amount: 13320.7, selected: true },
        { id: 16, name: 'Обеспечение проведения выборов и референдумов', amount: 0, selected: true },
        { id: 17, name: 'Резервные фонды', amount: 0, selected: true },
        { id: 18, name: 'Другие общегосударственные вопросы', amount: 53298.2, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Национальная безопасность и правоохранительная деятельность',
      amount: 7047.30,
      selected: true,
      color: projectColors[1],
      subProjects: [
        { id: 21, name: 'Органы юстиции', amount: 1148.80, selected: true },
        { id: 22, name: 'Защита населения и территории от чрезвычайных ситуаций природного и техногенного характера, пожарная безопасность', amount: 5898.50, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Национальная экономика',
      amount: 16404.50,
      selected: true,
      color: projectColors[2],
      subProjects: [
        { id: 31, name: 'Сельское хозяйство и рыболовство', amount: 6421.30, selected: true },
        { id: 32, name: 'Транспорт', amount: 475.90, selected: true },
        { id: 33, name: 'Другие вопросы в области национальной экономики', amount: 9507.30, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Жилищно-коммунальное хозяйство',
      amount: 452.10,
      selected: true,
      color: projectColors[3],
      subProjects: [
        { id: 41, name: 'Жилищное хозяйство', amount: 452.10, selected: true },
        { id: 42, name: 'Другие вопросы в области жилищно-коммунального хозяйства', amount: 0, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Образование',
      amount: 756327.30,
      selected: true,
      color: projectColors[4],
      subProjects: [
        { id: 51, name: 'Дошкольное образование', amount: 222986.80, selected: true },
        { id: 52, name: 'Общее образование', amount: 466007.50, selected: true },
        { id: 53, name: 'Дополнительное образование детей', amount: 37965.60, selected: true },
        { id: 54, name: 'Профессиональная подготовка, переподготовка и повышение квалификации', amount: 155.20, selected: true },
        { id: 55, name: 'Молодежная политика', amount: 561.30, selected: true },
        { id: 56, name: 'Другие вопросы в области образования', amount: 28650.90, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Культура, кинематография',
      amount: 13440.20,
      selected: true,
      color: projectColors[5],
      subProjects: [
        { id: 61, name: 'Культура', amount: 13440.20, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Здравоохранение',
      amount: 40.00,
      selected: true,
      color: projectColors[6],
      subProjects: [
        { id: 71, name: 'Другие вопросы в области здравоохранения', amount: 40.00, selected: true }
      ]
    },
    {
      id: 8,
      name: 'Социальная политика',
      amount: 69915.00,
      selected: true,
      color: projectColors[7],
      subProjects: [
        { id: 81, name: 'Пенсионное обеспечение', amount: 1754.00, selected: true },
        { id: 82, name: 'Охрана семьи и детства', amount: 67715.30, selected: true },
        { id: 83, name: 'Другие вопросы в области социальной политики', amount: 445.70, selected: true }
      ]
    },
    {
      id: 9,
      name: 'Физическая культура и спорт',
      amount: 18673.40,
      selected: true,
      color: projectColors[8],
      subProjects: [
        { id: 91, name: 'Физическая культура', amount: 12747.30, selected: true },
        { id: 92, name: 'Массовый спорт', amount: 1173.70, selected: true },
        { id: 93, name: 'Спорт высших достижений', amount: 4752.40, selected: true }
      ]
    },
    {
      id: 10,
      name: 'Межбюджетные трансферты общего характера бюджетам бюджетной системы РФ',
      amount: 72799.70,
      selected: true,
      color: projectColors[9],
      subProjects: [
        { id: 101, name: 'Дотации на выравнивание бюджетной обеспеченности субъектов Российской Федерации и муниципальных образований', amount: 61875.00, selected: true },
        { id: 102, name: 'Иные дотации', amount: 10924.70, selected: true }
      ]
    },
    {
      id: 11,
      name: 'Условно утвержденные расходы',
      amount: 0.00,
      selected: true,
      color: projectColors[10],
      subProjects: []
    }
  ],
  2025: [
    {
      id: 1,
      name: 'Общегосударственные вопросы',
      amount: 317899.40,
      selected: true,
      color: projectColors[11],
      subProjects: [
        { id: 11, name: 'Функционирование высшего должностного лица субъекта Российской Федерации и муниципального образования', amount: 5287.2, selected: true },
        { id: 12, name: 'Функционирование законодательных (представительных) органов государственной власти и представительных органов муниципальных образований', amount: 1201.7, selected: true },
        { id: 13, name: 'Функционирование Правительства Российской Федерации, высших исполнительных органов субъектов Российской Федерации, местных администраций', amount: 34350.6, selected: true },
        { id: 14, name: 'Судебная система', amount: 3.0, selected: true },
        { id: 15, name: 'Обеспечение деятельности финансовых, налоговых и таможенных органов и органов финансового (финансово-бюджетного) надзора', amount: 17847.3, selected: true },
        { id: 16, name: 'Обеспечение проведения выборов и референдумов', amount: 3292.4, selected: true },
        { id: 17, name: 'Резервные фонды', amount: 500.0, selected: true },
        { id: 18, name: 'Другие общегосударственные вопросы', amount: 75417.2, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Национальная безопасность и правоохранительная деятельность',
      amount: 8358.80,
      selected: true,
      color: projectColors[12],
      subProjects: [
        { id: 21, name: 'Органы юстиции', amount: 1715.50, selected: true },
        { id: 22, name: 'Защита населения и территории от чрезвычайных ситуаций природного и техногенного характера, пожарная безопасность', amount: 6643.30, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Национальная экономика',
      amount: 19584.30,
      selected: true,
      color: projectColors[13],
      subProjects: [
        { id: 31, name: 'Сельское хозяйство и рыболовство', amount: 8523.90, selected: true },
        { id: 32, name: 'Транспорт', amount: 634.10, selected: true },
        { id: 33, name: 'Другие вопросы в области национальной экономики', amount: 10426.30, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Жилищно-коммунальное хозяйство',
      amount: 3306.20,
      selected: true,
      color: projectColors[14],
      subProjects: [
        { id: 41, name: 'Жилищное хозяйство', amount: 3263.40, selected: true },
        { id: 42, name: 'Другие вопросы в области жилищно-коммунального хозяйства', amount: 42.80, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Образование',
      amount: 820134.00,
      selected: true,
      color: projectColors[15],
      subProjects: [
        { id: 51, name: 'Дошкольное образование', amount: 221433.20, selected: true },
        { id: 52, name: 'Общее образование', amount: 528672.70, selected: true },
        { id: 53, name: 'Дополнительное образование детей', amount: 47311.50, selected: true },
        { id: 54, name: 'Профессиональная подготовка, переподготовка и повышение квалификации', amount: 322.30, selected: true },
        { id: 55, name: 'Молодежная политика', amount: 566.60, selected: true },
        { id: 56, name: 'Другие вопросы в области образования', amount: 21827.70, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Культура, кинематография',
      amount: 15213.80,
      selected: true,
      color: projectColors[16],
      subProjects: [
        { id: 61, name: 'Культура', amount: 15213.80, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Здравоохранение',
      amount: 0.00,
      selected: true,
      color: projectColors[17],
      subProjects: [
        { id: 71, name: 'Другие вопросы в области здравоохранения', amount: 0.00, selected: true }
      ]
    },
    {
      id: 8,
      name: 'Социальная политика',
      amount: 55039.90,
      selected: true,
      color: projectColors[18],
      subProjects: [
        { id: 81, name: 'Пенсионное обеспечение', amount: 3010.20, selected: true },
        { id: 82, name: 'Охрана семьи и детства', amount: 51693.00, selected: true },
        { id: 83, name: 'Другие вопросы в области социальной политики', amount: 336.70, selected: true }
      ]
    },
    {
      id: 9,
      name: 'Физическая культура и спорт',
      amount: 20445.70,
      selected: true,
      color: projectColors[19],
      subProjects: [
        { id: 91, name: 'Физическая культура', amount: 13866.70, selected: true },
        { id: 92, name: 'Массовый спорт', amount: 1350.00, selected: true },
        { id: 93, name: 'Спорт высших достижений', amount: 5229.00, selected: true }
      ]
    },
    {
      id: 10,
      name: 'Межбюджетные трансферты общего характера бюджетам бюджетной системы РФ',
      amount: 79060.20,
      selected: true,
      color: projectColors[20],
      subProjects: [
        { id: 101, name: 'Дотации на выравнивание бюджетной обеспеченности субъектов Российской Федерации и муниципальных образований', amount: 64314.00, selected: true },
        { id: 102, name: 'Иные дотации', amount: 14746.20, selected: true }
      ]
    },
    {
      id: 11,
      name: 'Условно утвержденные расходы',
      amount: 0.00,
      selected: true,
      color: projectColors[21],
      subProjects: []
    }
  ],
  2026: [
    {
      id: 1,
      name: 'Общегосударственные вопросы',
      amount: 100167.20,
      selected: true,
      color: projectColors[22],
      subProjects: [
        { id: 11, name: 'Функционирование высшего должностного лица субъекта Российской Федерации и муниципального образования', amount: 2708.7, selected: true },
        { id: 12, name: 'Функционирование законодательных (представительных) органов государственной власти и представительных органов муниципальных образований', amount: 877.8, selected: true },
        { id: 13, name: 'Функционирование Правительства Российской Федерации, высших исполнительных органов субъектов Российской Федерации, местных администраций', amount: 31480.5, selected: true },
        { id: 14, name: 'Судебная система', amount: 115.5, selected: true },
        { id: 15, name: 'Обеспечение деятельности финансовых, налоговых и таможенных органов и органов финансового (финансово-бюджетного) надзора', amount: 15573.7, selected: true },
        { id: 16, name: 'Обеспечение проведения выборов и референдумов', amount: 0, selected: true },
        { id: 17, name: 'Резервные фонды', amount: 500.0, selected: true },
        { id: 18, name: 'Другие общегосударственные вопросы', amount: 48911.0, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Национальная безопасность и правоохранительная деятельность',
      amount: 8219.10,
      selected: true,
      color: projectColors[23],
      subProjects: [
        { id: 21, name: 'Органы юстиции', amount: 1761.70, selected: true },
        { id: 22, name: 'Защита населения и территории от чрезвычайных ситуаций природного и техногенного характера, пожарная безопасность', amount: 6457.40, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Национальная экономика',
      amount: 18058.60,
      selected: true,
      color: projectColors[24],
      subProjects: [
        { id: 31, name: 'Сельское хозяйство и рыболовство', amount: 8287.90, selected: true },
        { id: 32, name: 'Транспорт', amount: 700.00, selected: true },
        { id: 33, name: 'Другие вопросы в области национальной экономики', amount: 9070.70, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Жилищно-коммунальное хозяйство',
      amount: 2899.40,
      selected: true,
      color: projectColors[25],
      subProjects: [
        { id: 41, name: 'Жилищное хозяйство', amount: 2856.60, selected: true },
        { id: 42, name: 'Другие вопросы в области жилищно-коммунального хозяйства', amount: 42.80, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Образование',
      amount: 768676.70,
      selected: true,
      color: projectColors[26],
      subProjects: [
        { id: 51, name: 'Дошкольное образование', amount: 214915.90, selected: true },
        { id: 52, name: 'Общее образование', amount: 487855.30, selected: true },
        { id: 53, name: 'Дополнительное образование детей', amount: 45426.70, selected: true },
        { id: 54, name: 'Профессиональная подготовка, переподготовка и повышение квалификации', amount: 12.00, selected: true },
        { id: 55, name: 'Молодежная политика', amount: 0.00, selected: true },
        { id: 56, name: 'Другие вопросы в области образования', amount: 20466.80, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Культура, кинематография',
      amount: 4549.20,
      selected: true,
      color: projectColors[27],
      subProjects: [
        { id: 61, name: 'Культура', amount: 4549.20, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Здравоохранение',
      amount: 0.00,
      selected: true,
      color: projectColors[28],
      subProjects: [
        { id: 71, name: 'Другие вопросы в области здравоохранения', amount: 0.00, selected: true }
      ]
    },
    {
      id: 8,
      name: 'Социальная политика',
      amount: 54560.80,
      selected: true,
      color: projectColors[29],
      subProjects: [
        { id: 81, name: 'Пенсионное обеспечение', amount: 0.00, selected: true },
        { id: 82, name: 'Охрана семьи и детства', amount: 54186.70, selected: true },
        { id: 83, name: 'Другие вопросы в области социальной политики', amount: 374.10, selected: true }
      ]
    },
    {
      id: 9,
      name: 'Физическая культура и спорт',
      amount: 29272.00,
      selected: true,
      color: projectColors[30],
      subProjects: [
        { id: 91, name: 'Физическая культура', amount: 23284.80, selected: true },
        { id: 92, name: 'Массовый спорт', amount: 758.20, selected: true },
        { id: 93, name: 'Спорт высших достижений', amount: 5229.00, selected: true }
      ]
    },
    {
      id: 10,
      name: 'Межбюджетные трансферты общего характера бюджетам бюджетной системы РФ',
      amount: 43327.60,
      selected: true,
      color: projectColors[31],
      subProjects: [
        { id: 101, name: 'Дотации на выравнивание бюджетной обеспеченности субъектов Российской Федерации и муниципальных образований', amount: 42547.00, selected: true },
        { id: 102, name: 'Иные дотации', amount: 780.60, selected: true }
      ]
    },
    {
      id: 11,
      name: 'Условно утвержденные расходы',
      amount: 11000.00,
      selected: true,
      color: projectColors[32],
      subProjects: []
    }
  ],
  2027: [
    {
      id: 1,
      name: 'Общегосударственные вопросы',
      amount: 98049.7,
      selected: true,
      color: projectColors[33],
      subProjects: [
        { id: 11, name: 'Функционирование высшего должностного лица субъекта Российской Федерации и муниципального образования', amount: 2708.7, selected: true },
        { id: 12, name: 'Функционирование законодательных (представительных) органов государственной власти и представительных органов муниципальных образований', amount: 877.8, selected: true },
        { id: 13, name: 'Функционирование Правительства Российской Федерации, высших исполнительных органов субъектов Российской Федерации, местных администраций', amount: 31480.5, selected: true },
        { id: 14, name: 'Судебная система', amount: 0, selected: true },
        { id: 15, name: 'Обеспечение деятельности финансовых, налоговых и таможенных органов и органов финансового (финансово-бюджетного) надзора', amount: 15571.7, selected: true },
        { id: 16, name: 'Обеспечение проведения выборов и референдумов', amount: 0, selected: true },
        { id: 17, name: 'Резервные фонды', amount: 500.0, selected: true },
        { id: 18, name: 'Другие общегосударственные вопросы', amount: 46911.0, selected: true }
      ]
    },
    {
      id: 2,
      name: 'Национальная безопасность и правоохранительная деятельность',
      amount: 8219.10,
      selected: true,
      color: projectColors[34],
      subProjects: [
        { id: 21, name: 'Органы юстиции', amount: 1761.70, selected: true },
        { id: 22, name: 'Защита населения и территории от чрезвычайных ситуаций природного и техногенного характера, пожарная безопасность', amount: 6457.40, selected: true }
      ]
    },
    {
      id: 3,
      name: 'Национальная экономика',
      amount: 17733.60,
      selected: true,
      color: projectColors[35],
      subProjects: [
        { id: 31, name: 'Сельское хозяйство и рыболовство', amount: 8662.90, selected: true },
        { id: 32, name: 'Транспорт', amount: 0.00, selected: true },
        { id: 33, name: 'Другие вопросы в области национальной экономики', amount: 9070.70, selected: true }
      ]
    },
    {
      id: 4,
      name: 'Жилищно-коммунальное хозяйство',
      amount: 2899.40,
      selected: true,
      color: projectColors[36],
      subProjects: [
        { id: 41, name: 'Жилищное хозяйство', amount: 2856.60, selected: true },
        { id: 42, name: 'Другие вопросы в области жилищно-коммунального хозяйства', amount: 42.80, selected: true }
      ]
    },
    {
      id: 5,
      name: 'Образование',
      amount: 931038.90,
      selected: true,
      color: projectColors[37],
      subProjects: [
        { id: 51, name: 'Дошкольное образование', amount: 216151.40, selected: true },
        { id: 52, name: 'Общее образование', amount: 648979.90, selected: true },
        { id: 53, name: 'Дополнительное образование детей', amount: 45426.70, selected: true },
        { id: 54, name: 'Профессиональная подготовка, переподготовка и повышение квалификации', amount: 12.00, selected: true },
        { id: 55, name: 'Молодежная политика', amount: 0.00, selected: true },
        { id: 56, name: 'Другие вопросы в области образования', amount: 20468.90, selected: true }
      ]
    },
    {
      id: 6,
      name: 'Культура, кинематография',
      amount: 4200.00,
      selected: true,
      color: projectColors[38],
      subProjects: [
        { id: 61, name: 'Культура', amount: 4200.00, selected: true }
      ]
    },
    {
      id: 7,
      name: 'Здравоохранение',
      amount: 0.00,
      selected: true,
      color: projectColors[39],
      subProjects: [
        { id: 71, name: 'Другие вопросы в области здравоохранения', amount: 0.00, selected: true }
      ]
    },
    {
      id: 8,
      name: 'Социальная политика',
      amount: 54560.80,
      selected: true,
      color: projectColors[40],
      subProjects: [
        { id: 81, name: 'Пенсионное обеспечение', amount: 0.00, selected: true },
        { id: 82, name: 'Охрана семьи и детства', amount: 54186.70, selected: true },
        { id: 83, name: 'Другие вопросы в области социальной политики', amount: 374.10, selected: true }
      ]
    },
    {
      id: 9,
      name: 'Физическая культура и спорт',
      amount: 19171.00,
      selected: true,
      color: projectColors[41],
      subProjects: [
        { id: 91, name: 'Физическая культура', amount: 13183.80, selected: true },
        { id: 92, name: 'Массовый спорт', amount: 758.20, selected: true },
        { id: 93, name: 'Спорт высших достижений', amount: 5229.00, selected: true }
      ]
    },
    {
      id: 10,
      name: 'Межбюджетные трансферты общего характера бюджетам бюджетной системы РФ',
      amount: 40975.60,
      selected: true,
      color: projectColors[42],
      subProjects: [
        { id: 101, name: 'Дотации на выравнивание бюджетной обеспеченности субъектов Российской Федерации и муниципальных образований', amount: 40195.00, selected: true },
        { id: 102, name: 'Иные дотации', amount: 780.60, selected: true }
      ]
    },
    {
      id: 11,
      name: 'Условно утвержденные расходы',
      amount: 22000.00,
      selected: true,
      color: projectColors[43],
      subProjects: []
    }
  ]
};
let projectsChart = null;
let currentProjectsChartType = 'bar';
// Инициативные проекты
const initiativesData = {
  projects: [
    {
      id: 1,
      name: 'Региональный проект "Инициативное бюджетирование"',
      year: 2023,
      totalBudget: 2177.9,
      regionalBudget: 1425.0,
      localBudget: 427.2,
      initiativePayments: 325.3,
      subProjects: [
        { id: 101, name: 'Новоорский поссовет: Ремонт дома культуры п.Гранитный', amount: 1212.2, regional: 700.0, local: 282.2, initiative: 230.0 },
        { id: 102, name: 'Приреченский сельсовет: Приобретение детской площадки', amount: 965.7, regional: 725.0, local: 145.0, initiative: 95.3 }
      ]
    },
    {
      id: 2,
      name: 'Районный проект "Народный бюджет"',
      year: 2023,
      totalBudget: 694.2,
      regionalBudget: 0.0,
      localBudget: 573.9,
      initiativePayments: 120.3,
      subProjects: [
        { id: 201, name: 'Будамшинский сельсовет: Замена дверных блоков в СДК с. Будамша', amount: 240.0, regional: 0.0, local: 178.0, initiative: 62.0 },
        { id: 202, name: 'Кумакский сельсовет: Выпиловка аварийных деревьев на православном кладбище', amount: 164.1, regional: 0, local: 132.8, initiative: 31.3 },
        { id: 203, name: 'Новоорский поссовет :Ремонт центрального крыльца Сельского дома культуры по адресу пос. Новоорск ул.Клецова дом №14б', amount: 155.9, regional: 0, local: 140.9, initiative: 15.0 },
        { id: 204, name: 'Чапаевский сельсовет :Ремонт скважины №1, №7 в с.Чапаевка', amount: 134.2, regional: 0, local: 122.2, initiative: 12.0 }
      ]
    },
    {
      id: 3,
      name: 'Районный проект "Твой школьный бюджет"',
      year: 2023,
      totalBudget: 100.0,
      regionalBudget: 0.0,
      localBudget: 100.0,
      initiativePayments: 0.0,
      subProjects: [
        { id: 301, name: 'Проект школы № 4 п. Новоорска «Создание школьного радиоузла как информационного центра школы»', amount: 100.0, regional: 0.0, local: 100.0, initiative: 0.0 }
      ]
    },
    {
      id: 4,
      name: 'Региональный проект "Инициативное бюджетирование"',
      year: 2024,
      totalBudget: 3242.8,
      regionalBudget: 1864.0,
      localBudget: 728.8,
      initiativePayments: 650.0,
      subProjects: [
        { id: 401, name: 'Новоорский поссовет: Ремонт дома культуры п.Гранитный', amount: 1774.2, regional: 1000.0, local: 374.2, initiative: 400.0 },
        { id: 402, name: 'Будамшинский сельсовет: Ремонт ограждения парка', amount: 1468.6, regional: 864.0, local: 354.6, initiative: 250.0 }
      ]
    },
    {
      id: 5,
      name: 'Районный проект "Народный бюджет"',
      year: 2024,
      totalBudget: 737.0,
      regionalBudget: 0,
      localBudget: 606.6,
      initiativePayments: 130.3,
      subProjects: [
        { id: 501, name: 'Горьковский сельсовет: Обустройство трех площадок наполнения ТКО в с.Горьковское', amount: 135.0, regional: 0, local: 118.5, initiative: 16.5 },
        { id: 502, name: 'Кумакский сельсовет: Выпиловка старых и поврежденных деревьев на православном кладбище', amount: 240.0, regional: 0, local: 170.0, initiative: 70.0 },
        { id: 503, name: 'Чапаевский сельсовет: Ремонт участка наружного водопровода ул.Советская от дома №7 до дома №9 с Чапаевка', amount: 117.6, regional: 0, local: 102.7, initiative: 14.9 },
        { id: 504, name: 'Караганский сельсовет: Монтаж системы видеонаблюдения и поставка оргтехники (МФУ)', amount: 129.9, regional: 0, local: 114.0, initiative: 15.9 },
        { id: 505, name: 'Будамшинский сельсовет: Устройство пандуса к зданию СДК с.Будамша', amount: 114.5, regional: 0, local: 101.4, initiative: 13.0 }
      ]
    },
    {
      id: 6,
      name: 'Районный проект "Твой школьный бюджет"',
      year: 2024,
      totalBudget: 240.0,
      regionalBudget: 0.0,
      localBudget: 240.0,
      initiativePayments: 0.0,
      subProjects: [
        { id: 601, name: 'Проект «Перезагрузка. Модернизация музейной комнаты» МАОУ СОШ с.Кумак', amount: 100.0, regional: 0.0, local: 100.0, initiative: 0.0 },
        { id: 602, name: 'Проект «СТОП-КАДР» МАОУ СОШ №2 п. Энергетик', amount: 80.0, regional: 0.0, local: 80.0, initiative: 0.0 },
        { id: 603, name: 'Проект «Театральная костюмерная» МАОУ СОШ №1 п. Энергетик', amount: 60.0, regional: 0.0, local: 60.0, initiative: 0.0 }
      ]
    },
    {
      id: 7,
      name: 'Региональный проект "Инициативное бюджетирование"',
      year: 2025,
      totalBudget: 333.80,
      regionalBudget: 232.0,
      localBudget: 46.8,
      initiativePayments: 55.0,
      subProjects: [
        { id: 701, name: 'Чапаевский	сельсовет: Приобретение спортивных тренажеров в ДК с. Чапаевка', amount: 333.8, regional: 232.0, local: 46.8, initiative: 55.0 }
      ]
    },
    {
      id: 8,
      name: 'Районный проект "Народный бюджет"',
      year: 2025,
      totalBudget: 1326.4,
      regionalBudget: 0,
      localBudget: 1116.5,
      initiativePayments: 210.0,
      subProjects: [
        { id: 801, name: 'Чапаевский сельсовет: «Выпиловка деревьев с корчевкой пней, вывоз мусора с территории парка с. Чапаевка»', amount: 206.4, regional: 0, local: 176.4, initiative: 30.0 },
        { id: 802, name: 'Будамшинский сельсовет: «Приобретение детского игрового комплекса в с. Будамша»', amount: 210.0, regional: 0, local: 168.0, initiative: 42.0 },
        { id: 803, name: 'Будамшинский сельсовет: «Приобретение детского игрового комплекса в с. Скалистое»', amount: 210.0, regional: 0, local: 168.0, initiative: 42.0 },
        { id: 804, name: 'Горьковский сельсовет: «Установка дополнительного ограждения на православном кладбище в с. Горьковское»', amount: 179.7, regional: 0, local: 164.9, initiative: 14.8 },
        { id: 805, name: 'Горькоский сельсовет: «Частичный ремонт крыши клуба по адресу с. Лужки ул. Школьная д. 5»', amount: 90.0, regional: 0, local: 83.8, initiative: 6.2 },
        { id: 806, name: 'Энергетикский поссовет: «Ремонт участка тепловой сети от точки врезки в районе строения № 99 до точки врезки в районе магазина "Олимпийский"', amount: 430.4, regional: 0, local: 355.4, initiative: 75.0 }
      ]
    },
    {
      id: 9,
      name: 'Районный проект "Твой школьный бюджет"',
      year: 2025,
      totalBudget: 240.0,
      regionalBudget: 0.0,
      localBudget: 240.0,
      initiativePayments: 0,
      subProjects: [
        { id: 901, name: 'Конкурсный отбор будет проведен в сентябре 2025 года', amount: 0.0, regional: 0.0, local: 240.0, initiative: 0.0 }
      ]
    }
  ],
  years: [2023, 2024, 2025],

};
// Глобальные переменные
let currentChart = null;
let expensesChart = null;
let currentYear = 2025;
let currentExpensesYear = 2025;
let currentChartType = 'bar';
let currentExpensesChartType = 'bar';
let currentTab = 'income';
let expandedProjects = new Set();
let expandedInitiatives = new Set();
// Функция для отладки расходов
function debugExpenses() {
  console.log('=== DEBUG EXPENSES ===');
  console.log('Current expenses year:', currentExpensesYear);
  console.log('Current chart type:', currentExpensesChartType);
  console.log('Selected expenses:', getSelectedExpenses());
  console.log('Expenses amount:', calculateExpensesAmount());
  console.log('Expenses data for current year:', expensesItemsData[currentExpensesYear]);
  console.log('Canvas element:', document.getElementById('expensesChart'));
  console.log('======================');
}
// Функция для переключения вкладок
function changeTab(tabName) {
  // Скрываем весь контент
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  // Обновляем кнопки вкладок
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  // Показываем выбранную вкладку
  document.getElementById(`tab-${tabName}`).classList.add('active');
  document.querySelector(`.tab-btn.${tabName}`).classList.add('active');
  if (tabName === 'projects') {
    setTimeout(() => {
      initProjectsChart(currentProjectsChartType);
      populateProjectsTable(); // Эта функция теперь включает renderInitiativesTable()
    }, 100);
  }
  // Инициализируем соответствующую диаграмму
  if (tabName === 'income') {
    initChart(currentChartType);
  } else if (tabName === 'expenses') {
    // Небольшая задержка для гарантии отрисовки DOM
    setTimeout(() => {
      initExpensesChart(currentExpensesChartType);
    }, 100);
  } else if (tabName === 'projects') {
    // Инициализируем диаграмму и таблицу проектов
    setTimeout(() => {
      initProjectsChart(currentProjectsChartType);
      populateProjectsTable();
    }, 100);
  }

  currentTab = tabName;
}
// Функция для переключения раскрытия/сворачивания подпроектов
function toggleSubProjects(projectId, event) {
  event.stopPropagation();

  if (expandedProjects.has(projectId)) {
    expandedProjects.delete(projectId);
  } else {
    expandedProjects.add(projectId);
  }
  renderProjects();
}
// Функция для переключения основного проекта
function toggleProject(projectId, event) {
  if (event) event.stopPropagation();

  const project = projectsData[currentYear].find(p => p.id === projectId);
  if (project) {
    project.selected = !project.selected;

    if (project.selected && project.subProjects && project.subProjects.length > 0) {
      project.subProjects.forEach(subProject => {
        subProject.selected = true;
      });
    }

    renderProjects();
    initChart(currentChartType);
    populateTable(); // ← Добавьте этот вызов
    updateTotalIncome();
  }
}

function toggleSubProject(projectId, subProjectId, event) {
  event.stopPropagation();

  const project = projectsData[currentYear].find(p => p.id === projectId);
  if (project && project.subProjects) {
    const subProject = project.subProjects.find(sp => sp.id === subProjectId);
    if (subProject) {
      subProject.selected = !subProject.selected;
      updateMainProjectSelection(project);

      renderProjects();
      initChart(currentChartType);
      populateTable(); // ← Добавьте этот вызов
      updateTotalIncome();
    }
  }
}
// Обновление статуса основного проекта на основе подпроектов
function updateMainProjectSelection(project) {
  if (project.subProjects && project.subProjects.length > 0) {
    const allSelected = project.subProjects.every(sp => sp.selected);
    const someSelected = project.subProjects.some(sp => sp.selected);

    if (allSelected) {
      project.selected = true;
    } else if (someSelected) {
      project.selected = false; // Частичный выбор
    } else {
      project.selected = false;
    }
  }
}
// Функция для получения всех выбранных проектов (основных и подпроектов)
function getAllSelectedProjects() {
  const selectedItems = [];

  if (!projectsData[currentYear]) return selectedItems;

  projectsData[currentYear].forEach(project => {
    if (project.selected) {
      // Если есть подпроекты и они все выбраны, добавляем основной проект
      if (project.subProjects && project.subProjects.length > 0 &&
        project.subProjects.every(sp => sp.selected)) {
        selectedItems.push({
          id: project.id,
          name: project.name,
          amount: project.amount,
          color: project.color
        });
      } else if (project.subProjects && project.subProjects.length > 0) {
        // Добавляем отдельные выбранные подпроекты
        project.subProjects.forEach(subProject => {
          if (subProject.selected) {
            selectedItems.push({
              id: subProject.id,
              name: `${project.name} - ${subProject.name}`,
              amount: subProject.amount,
              color: lightenColor(project.color, 30)
            });
          }
        });
      } else {
        // Проект без подпроектов
        selectedItems.push({
          id: project.id,
          name: project.name,
          amount: project.amount,
          color: project.color
        });
      }
    }
  });

  return selectedItems;
}
// Функция для расчета общей суммы выбранных проектов
function calculateProjectAmount() {
  let total = 0;

  if (!projectsData[currentYear]) return total;

  projectsData[currentYear].forEach(project => {
    if (project.selected) {
      if (project.subProjects && project.subProjects.length > 0) {
        // Суммируем выбранные подпроекты
        project.subProjects.forEach(subProject => {
          if (subProject.selected) {
            total += subProject.amount;
          }
        });
      } else {
        total += project.amount;
      }
    }
  });

  return total;
}
// Обновленная функция renderProjects для отображения вложенной структуры
function renderProjects() {
  const fragment = document.createDocumentFragment();
  const projectsGrid = document.getElementById('projectsGrid');
  if (!projectsGrid) return;

  if (!projectsData[currentYear] || projectsData[currentYear].length === 0) {
    projectsGrid.innerHTML = '<div class="no-data">Нет данных для отображения</div>';
    return;
  }

  // Безопасная очистка
  projectsGrid.textContent = '';

  projectsData[currentYear].forEach((project, index) => {
    const hasSubProjects = project.subProjects && project.subProjects.length > 0;
    const isExpanded = expandedProjects.has(project.id);
    const selectedSubCount = hasSubProjects ?
      project.subProjects.filter(sp => sp.selected).length : 0;
    const totalSubCount = hasSubProjects ? project.subProjects.length : 0;

    const projectCard = document.createElement('div');
    projectCard.className = `project-card income ${project.selected ? 'selected' : ''} ${hasSubProjects ? 'has-subprojects' : ''}`;
    projectCard.style.borderLeftColor = project.color;
    projectCard.style.backgroundColor = project.selected ?
      lightenColor(project.color, 90) : 'white';

    // Создаем элементы безопасно
    const projectHeader = document.createElement('div');
    projectHeader.className = 'project-header';
    projectHeader.onclick = (e) => toggleProject(project.id, e);

    const projectInfo = document.createElement('div');
    projectInfo.className = 'project-info';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'project-name';
    nameDiv.textContent = project.name;

    if (hasSubProjects) {
      const countSpan = document.createElement('span');
      countSpan.className = 'selection-count';
      countSpan.textContent = `(${selectedSubCount}/${totalSubCount})`;
      nameDiv.appendChild(countSpan);
    }

    const amountDiv = document.createElement('div');
    amountDiv.className = 'project-amount';
    amountDiv.textContent = formatCurrency(project.amount);

    projectInfo.appendChild(nameDiv);
    projectInfo.appendChild(amountDiv);
    projectHeader.appendChild(projectInfo);

    if (hasSubProjects) {
      const toggleBtn = document.createElement('button');
      toggleBtn.className = `toggle-subprojects-btn ${isExpanded ? 'expanded' : ''}`;
      toggleBtn.textContent = '►';
      toggleBtn.onclick = (e) => toggleSubProjects(project.id, e);
      projectHeader.appendChild(toggleBtn);
    }

    const typeDiv = document.createElement('div');
    typeDiv.className = 'project-type';
    const percentage = ((project.amount / financialData.incomes[
      financialData.years.indexOf(currentYear.toString())]) * 100).toFixed(2);
    typeDiv.textContent = `${percentage}% от общего дохода`;

    projectCard.appendChild(projectHeader);
    projectCard.appendChild(typeDiv);
    fragment.appendChild(projectCard);

    // Отображаем подпроекты если они есть и проект раскрыт
    if (hasSubProjects && isExpanded) {
      const subContainer = document.createElement('div');
      subContainer.className = 'subprojects-container';

      project.subProjects.forEach(subProject => {
        const subProjectCard = document.createElement('div');
        subProjectCard.className = `subproject-card ${subProject.selected ? 'selected' : ''}`;
        subProjectCard.onclick = (e) => toggleSubProject(project.id, subProject.id, e);
        subProjectCard.style.borderLeftColor = lightenColor(project.color, 30);
        subProjectCard.style.backgroundColor = subProject.selected ?
          lightenColor(project.color, 95) : '#fafafa';

        const subProjectInfo = document.createElement('div');
        subProjectInfo.className = 'project-info';

        const subNameDiv = document.createElement('div');
        subNameDiv.className = 'project-name';
        subNameDiv.textContent = subProject.name;

        const subAmountDiv = document.createElement('div');
        subAmountDiv.className = 'project-amount';
        subAmountDiv.textContent = formatCurrency(subProject.amount);

        subProjectInfo.appendChild(subNameDiv);
        subProjectInfo.appendChild(subAmountDiv);

        const subTypeDiv = document.createElement('div');
        subTypeDiv.className = 'project-type';
        const subPercentage = ((subProject.amount / project.amount) * 100).toFixed(2);
        subTypeDiv.textContent = `${subPercentage}% от ${project.name}`;

        subProjectCard.appendChild(subProjectInfo);
        subProjectCard.appendChild(subTypeDiv);
        subContainer.appendChild(subProjectCard);
      });

      fragment.appendChild(subContainer);
    }
  });

  // Добавляем все элементы за один раз
  projectsGrid.appendChild(fragment);
}
// Функция для инициализации диаграммы доходов
function initChart(type = 'bar') {
  if (currentTab !== 'income') return;
  currentChartType = type;
  const ctx = document.getElementById('financeChart').getContext('2d');
  // Уничтожаем предыдущую диаграмму если она существует
  if (currentChart) {
    currentChart.destroy();
  }
  // Очищаем выносные метки
  document.getElementById('chartLabels').innerHTML = '';
  const selectedProjects = getAllSelectedProjects();
  const projectIncomes = calculateProjectAmount();
  if (type === 'doughnut') {
    // Диаграмма-бублик с проектами
    const labels = [];
    const data = [];
    const backgroundColors = [];
    selectedProjects.forEach((project) => {
      labels.push(project.name);
      data.push(project.amount);
      backgroundColors.push(project.color);
    });
    // Добавляем остальные суммы если есть невыбранные проекты
    const yearIndex = financialData.years.indexOf(currentYear.toString());
    const remainingIncome = financialData.incomes[yearIndex] - projectIncomes;
    if (remainingIncome > 0) {
      labels.push('Другие проекты');
      data.push(remainingIncome);
      backgroundColors.push('#BDBDBD');
    }
    currentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors,
          borderWidth: 2,
          borderColor: '#fff',
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%', // Эффект "бублика"
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${formatCurrency(value)} (${percentage}%)`;
              }
            }
          }
        }
      },
      plugins: [{
        id: 'externalLabels',
        afterDraw: function (chart) {
          createExternalLabels(chart, 'chartLabels');
        }
      }]
    });
  } else {
    // Для столбчатых и линейных диаграмм показываем детализацию по проектам
    if (selectedProjects.length > 0) {
      // Детализация по проектам для текущего года
      const labels = selectedProjects.map(project => project.name);
      const data = selectedProjects.map(project => project.amount);
      const backgroundColors = selectedProjects.map(project => project.color);
      const borderColors = selectedProjects.map(project => darkenColor(project.color, 20));

      currentChart = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: `Доходы (${currentYear})`,
            data: data,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Сумма доходов (тыс. руб.)'
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              },
              ticks: {
                callback: function (value) {
                  return formatCurrencyShort(value);
                }
              }
            },
            x: {
              title: {
                display: true,
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              }
            }
          }
        }
      });
    } else {
      // Если нет выбранных проектов - показываем общую динамику по годам
      currentChart = new Chart(ctx, {
        type: type,
        data: {
          labels: financialData.years,
          datasets: [{
            label: 'Общие доходы',
            data: financialData.incomes,
            backgroundColor: 'rgba(76, 175, 80, 0.6)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Динамика доходов по годам',
              font: { size: 16 }
            },
            legend: {
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Сумма доходов (тыс. руб.)'
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              },
              ticks: {
                callback: function (value) {
                  return formatCurrencyShort(value);
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Год'
              },
              grid: {
                color: 'rgba(0,0,0,0.1)'
              }
            }
          }
        }
      });
    }
  }
}

// Функция для инициализации диаграммы расходов (обновлена для поддержки сносок)
function initExpensesChart(type = 'bar') {
  console.log('Initializing expenses chart with type:', type);
  if (currentTab !== 'expenses') {
    console.log('Not on expenses tab, skipping');
    return;
  }
  currentExpensesChartType = type;
  const canvas = document.getElementById('expensesChart');
  if (!canvas) {
    console.error('Canvas element not found!');
    return;
  }
  const ctx = canvas.getContext('2d');

  // Уничтожаем предыдущую диаграмму если она существует
  if (expensesChart) {
    console.log('Destroying previous chart');
    expensesChart.destroy();
  }

  // Очищаем выносные метки
  const labelsContainer = document.getElementById('expensesChartLabels');
  if (labelsContainer) {
    labelsContainer.innerHTML = '';
  }

  const selectedExpenses = getSelectedExpenses();
  const expensesAmount = calculateExpensesAmount();

  // ФИКС: Фильтруем нулевые и отрицательные значения
  const filteredExpenses = selectedExpenses.filter(item => item.amount > 0);

  console.log('Selected expenses:', filteredExpenses);
  console.log('Expenses amount:', expensesAmount);

  if (type === 'doughnut') {
    console.log('Creating doughnut chart');

    const labels = [];
    const data = [];
    const backgroundColors = [];

    // Используем отфильтрованные данные
    filteredExpenses.forEach((item) => {
      labels.push(item.name);
      data.push(item.amount);
      backgroundColors.push(item.color);
    });

    // Добавляем остальные суммы если есть невыбранные статьи
    const yearIndex = expensesData.years.indexOf(currentExpensesYear.toString());
    const totalExpenses = expensesData.expenses[yearIndex];
    const remainingExpenses = totalExpenses - expensesAmount;

    console.log('Total expenses:', totalExpenses, 'Remaining:', remainingExpenses);

    if (remainingExpenses > 0) {
      labels.push('Другие расходы');
      data.push(remainingExpenses);
      backgroundColors.push('#CCCCCC');
    }

    // ФИКС: Проверяем, есть ли данные для отображения
    if (data.length === 0 || data.reduce((sum, val) => sum + val, 0) <= 0) {
      console.log('No valid data available, showing placeholder');
      labels.push('Нет данных для отображения');
      data.push(1);
      backgroundColors.push('#EEEEEE');
    }

    console.log('Final chart data:', { labels, data, backgroundColors });

    try {
      expensesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderWidth: 2,
            borderColor: '#fff',
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                pointStyle: 'circle',
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        },
        plugins: [{
          id: 'externalLabels',
          afterDraw: function (chart) {
            createExternalLabels(chart, 'expensesChartLabels');
          }
        }]
      });

      console.log('Doughnut chart with labels created successfully');
    } catch (error) {
      console.error('Error creating doughnut chart:', error);
    }
  } else {
    console.log('Creating bar/line chart');
    // Для столбчатых и линейных диаграмм
    if (selectedExpenses.length > 0) {
      // Детализация по статьям расходов
      const labels = selectedExpenses.map(item => item.name);
      const data = selectedExpenses.map(item => item.amount);
      const backgroundColors = selectedExpenses.map(item => item.color);
      const borderColors = selectedExpenses.map(item => darkenColor(item.color, 20));
      expensesChart = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: `Расходы (${currentExpensesYear})`,
            data: data,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Сумма расходов (тыс. руб.)'
              },
              ticks: {
                callback: function (value) {
                  return formatCurrencyShort(value);
                }
              }
            },
            x: {
              title: {
                display: true,
              }
            }
          }
        }
      });
    } else {
      // Общая динамика по годам
      expensesChart = new Chart(ctx, {
        type: type,
        data: {
          labels: expensesData.years,
          datasets: [{
            label: 'Общие расходы',
            data: expensesData.expenses,
            backgroundColor: 'rgba(220, 53, 69, 0.6)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Динамика расходов по годам',
              font: { size: 16 }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Сумма расходов (тыс. руб.)'
              },
              ticks: {
                callback: function (value) {
                  return formatCurrencyShort(value);
                }
              }
            }
          }
        }
      });
    }
  }
}
// Создание выносных меток для круговой диаграммы (без названий и цветных кружков в основной части метки)
function createExternalLabels(chart, labelsContainerId) {
  const labelsContainer = document.getElementById(labelsContainerId);
  if (!labelsContainer || !chart.chartArea) return;

  // Безопасная очистка
  labelsContainer.textContent = '';
  // Очищаем предыдущие метки
  labelsContainer.innerHTML = '';
  // Добавляем проверку на наличие данных
  const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
  if (total <= 0) return;
  // Добавляем небольшую задержку для гарантии отрисовки диаграммы
  setTimeout(() => {
    try {
      const chartArea = chart.chartArea;
      if (!chartArea) return;
      const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
      const centerX = chartArea.left + (chartArea.width / 2);
      const centerY = chartArea.top + (chartArea.height / 2);
      const radius = Math.min(chartArea.width, chartArea.height) / 2 * 0.75;
      // Получаем данные о сегментах
      const segments = [];
      let currentAngle = -Math.PI / 2;
      chart.data.datasets[0].data.forEach((value, index) => {
        if (value <= 0) return;
        const sliceAngle = (value / total) * 2 * Math.PI;
        const midAngle = currentAngle + (sliceAngle / 2);
        const percentage = ((value / total) * 100).toFixed(1);
        const labelText = chart.data.labels[index]; // Название для использования в тултипе
        segments.push({
          value,
          percentage,
          midAngle,
          index,
          label: labelText,
          color: chart.data.datasets[0].backgroundColor[index]
        });
        currentAngle += sliceAngle;
      });
      // Создаем метки для каждого сегмента (только сумма и процент)
      segments.forEach(segment => {
        const { midAngle, value, percentage, label } = segment; // color больше не используется
        // Позиционирование линии и текста
        const startX = centerX + Math.cos(midAngle) * radius;
        const startY = centerY + Math.sin(midAngle) * radius;
        // Определяем квадрант для позиционирования текста
        const isRightSide = Math.cos(midAngle) >= 0;
        const textDistance = radius + 60;
        const endX = centerX + Math.cos(midAngle) * textDistance;
        const endY = centerY + Math.sin(midAngle) * textDistance;
        // Длина линии
        const lineLength = textDistance - radius;
        // Создаем линию
        const line = document.createElement('div');
        line.className = 'label-line';
        line.style.position = 'absolute';
        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.width = `${lineLength}px`;
        line.style.transform = `rotate(${midAngle}rad)`;
        line.style.transformOrigin = '0 0';
        line.style.height = '1px';
        line.style.backgroundColor = '#999';
        line.style.opacity = '0.7';
        line.style.zIndex = '5';
        labelsContainer.appendChild(line);
        // Создаем текстовую метку (БЕЗ названия проекта и цветного кружка)
        const text = document.createElement('div');
        text.className = 'label-text';
        text.title = label; // Показываем название при наведении
        text.style.position = 'absolute';
        text.style.left = `${endX}px`;
        text.style.top = `${endY}px`;
        text.style.transform = 'translate(-50%, -50%)';
        text.style.textAlign = isRightSide ? 'left' : 'right';
        text.style.zIndex = '20';
        text.style.fontFamily = 'Arial, sans-serif';
        text.style.fontSize = '12px';
        text.style.color = '#333';
        text.style.background = 'white';
        text.style.padding = '5px 8px';
        text.style.borderRadius = '4px';
        text.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
        text.style.border = '1px solid #e0e0e0';
        text.style.minWidth = '80px'; // Минимальная ширина уменьшена
        text.style.lineHeight = '1.4';
        // Создаем элементы безопасно
        const valueDiv = document.createElement('div');
        Object.assign(valueDiv.style, {
          fontSize: '12px',
          fontWeight: 'bold',
          color: '#2c5282',
          textAlign: 'center'
        });
        valueDiv.textContent = formatCurrencyShort(value);

        const percentageDiv = document.createElement('div');
        Object.assign(percentageDiv.style, {
          fontSize: '11px',
          color: '#718096',
          textAlign: 'center'
        });
        percentageDiv.textContent = `${percentage}%`;

        // Очищаем и добавляем безопасно
        text.textContent = '';
        text.appendChild(valueDiv);
        text.appendChild(percentageDiv);
        labelsContainer.appendChild(text);
      });
      // Центральная метка с общей суммой (оставлена как есть)
      const centerText = document.createElement('div');
      centerText.className = 'center-label';
      centerText.style.position = 'absolute';
      centerText.style.left = `${centerX}px`;
      centerText.style.top = `${centerY}px`;
      centerText.style.transform = 'translate(-50%, -50%)';
      centerText.style.textAlign = 'center';
      centerText.style.zIndex = '10';
      centerText.style.fontFamily = 'Arial, sans-serif';
      centerText.style.fontSize = '16px';
      centerText.style.fontWeight = 'bold';
      centerText.style.color = '#2D3748';
      centerText.textContent = formatCurrencyShort(total);
      labelsContainer.appendChild(centerText);
    } catch (error) {
      console.warn('Не удалось создать выносные метки:', error);
    }
  }, 300);
}
// Функции для работы с доходами
function getSelectedProjects() {
  return projectsData[currentYear].filter(project => project.selected);
}
function calculateIncomeAmount() {
  return projectsData[currentYear]
    .filter(project => project.selected)
    .reduce((sum, project) => sum + project.amount, 0);
}
function changeYear(year, type = 'income') {
  if (type === 'income') {
    currentYear = year;
    expandedProjects.clear();
    document.querySelectorAll('#tab-income .year-btn').forEach(btn => {
      btn.classList.remove('active');
      if (parseInt(btn.textContent) === year) {
        btn.classList.add('active');
      }
    });

    updateTotalIncome();
    renderProjects();
    initChart(currentChartType);
    populateTable();
  } else if (type === 'expenses') {
    changeExpensesYear(year);
  }
}
// Обновлённая функция updateTotalIncome для скрытия надписи при сброшенных проектах
function updateTotalIncome() {
  const totalSelectedAmount = calculateProjectAmount(); // Сумма выбранных проектов

  const totalIncomeElement = document.getElementById('totalIncome');
  if (!totalIncomeElement) return;

  if (totalSelectedAmount <= 0) {
    // Если ничего не выбрано, скрываем надпись
    totalIncomeElement.style.display = 'none';
  } else {
    // Если что-то выбрано, показываем надпись с суммой выбранных
    totalIncomeElement.style.display = 'block'; // Убедимся, что элемент видим
    totalIncomeElement.textContent = `Общий доход за ${currentYear} год: ${formatCurrency(totalSelectedAmount)}`;
  }
}
function populateTable() {
  const tableBody = document.getElementById('dataTableBody');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  financialData.years.forEach((year, index) => {
    const row = document.createElement('tr');
    const isCurrentYear = parseInt(year) === currentYear;

    // Получаем выбранные проекты для текущего года
    let selectedProjectsInfo = 'Нет выбранных проектов';
    let selectedAmount = 0;

    if (isCurrentYear) {
      const selectedProjects = getAllSelectedProjects();
      selectedAmount = calculateProjectAmount();

      if (selectedProjects.length > 0) {
        selectedProjectsInfo = selectedProjects.map(p => p.name).join(', ');
      }
    }
    const yearCell = document.createElement('td');
    yearCell.textContent = year;

    const incomeCell = document.createElement('td');
    incomeCell.textContent = formatCurrency(financialData.incomes[index]);

    const projectsCell = document.createElement('td');

    if (isCurrentYear) {
      projectsCell.textContent = selectedProjectsInfo;
      if (selectedAmount > 0) {
        const br = document.createElement('br');
        const small = document.createElement('small');
        small.textContent = `Сумма: ${formatCurrency(selectedAmount)}`;
        projectsCell.appendChild(br);
        projectsCell.appendChild(small);
      }
    } else {
      projectsCell.textContent = '-';
    }

    row.appendChild(yearCell);
    row.appendChild(incomeCell);
    row.appendChild(projectsCell);
    tableBody.appendChild(row);
  });
}
// Функции для работы с расходами
function getSelectedExpenses() {
  return expensesItemsData[currentExpensesYear]
    .filter(item => item.selected && item.amount > 0);
}
// Функция для расчета общей суммы выбранных статей расходов
function calculateExpensesAmount() {
  let total = 0;
  expensesItemsData[currentExpensesYear].forEach(item => {
    if (item.selected) {
      if (item.subProjects && item.subProjects.length > 0) {
        // Если есть подстатьи, суммируем выбранные подстатьи
        item.subProjects.forEach(subProject => {
          if (subProject.selected) {
            total += subProject.amount;
          }
        });
      } else {
        total += item.amount;
      }
    }
  });
  return total;
}
function changeExpensesYear(year) {
  console.log('Changing expenses year to:', year);
  currentExpensesYear = year;
  expandedProjects.clear();
  document.querySelectorAll('#tab-expenses .year-btn').forEach(btn => {
    btn.classList.remove('active');
    if (parseInt(btn.textContent) === year) {
      btn.classList.add('active');
    }
  });
  updateTotalExpenses();
  renderExpenses();
  // Небольшая задержка для гарантии отрисовки
  setTimeout(() => {
    initExpensesChart(currentExpensesChartType);
  }, 50);

  populateExpensesTable();
}
function updateTotalExpenses() {
  const yearIndex = expensesData.years.indexOf(currentExpensesYear.toString());
  const totalExpenses = expensesData.expenses[yearIndex];
  const selectedAmount = calculateExpensesAmount();

  document.getElementById('totalExpenses').textContent =
    `Общие расходы за ${currentExpensesYear} год: ${formatCurrency(selectedAmount)}`;
}

function renderExpenses() {
  const expensesGrid = document.getElementById('expensesGrid');
  expensesGrid.innerHTML = '';

  expensesItemsData[currentExpensesYear].forEach(item => {
    const hasSubProjects = item.subProjects && item.subProjects.length > 0;
    const isExpanded = expandedProjects.has(item.id);
    const selectedSubCount = hasSubProjects ? item.subProjects.filter(sp => sp.selected).length : 0;
    const totalSubCount = hasSubProjects ? item.subProjects.length : 0;

    const itemCard = document.createElement('div');
    itemCard.className = `project-card ${item.selected ? 'selected' : ''} ${hasSubProjects ? 'has-subprojects' : ''}`;
    itemCard.onclick = (e) => toggleExpense(item.id, e);
    itemCard.style.borderLeftColor = item.color;
    itemCard.style.backgroundColor = item.selected ? lightenColor(item.color, 90) : 'white';
    // Создаем структуру безопасно
    const projectHeader = document.createElement('div');
    projectHeader.className = 'project-header';
    projectHeader.onclick = (e) => toggleExpense(item.id, e);

    const projectInfo = document.createElement('div');
    projectInfo.className = 'project-info';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'project-name';
    nameDiv.textContent = item.name;

    if (hasSubProjects) {
      const countSpan = document.createElement('span');
      countSpan.className = 'selection-count';
      countSpan.textContent = `(${selectedSubCount}/${totalSubCount})`;
      nameDiv.appendChild(countSpan);
    }

    const amountDiv = document.createElement('div');
    amountDiv.className = 'project-amount';
    amountDiv.textContent = formatCurrency(item.amount);

    projectInfo.appendChild(nameDiv);
    projectInfo.appendChild(amountDiv);
    projectHeader.appendChild(projectInfo);

    if (hasSubProjects) {
      const toggleBtn = document.createElement('button');
      toggleBtn.className = `toggle-subprojects-btn ${isExpanded ? 'expanded' : ''}`;
      toggleBtn.textContent = '►';
      toggleBtn.onclick = (e) => toggleSubExpenses(item.id, e);
      projectHeader.appendChild(toggleBtn);
    }
    const typeDiv = document.createElement('div');
    typeDiv.className = 'project-type';
    const percentage = ((item.amount / expensesData.expenses[expensesData.years.indexOf(currentExpensesYear.toString())]) * 100).toFixed(2);
    typeDiv.textContent = `${percentage}% от общих расходов`;
    // Собираем карточку
    itemCard.appendChild(projectHeader);
    itemCard.appendChild(typeDiv);
    expensesGrid.appendChild(itemCard);

    // Отображаем подстатьи если они есть и статья раскрыта
    if (hasSubProjects && isExpanded) {
      const subContainer = document.createElement('div');
      subContainer.className = 'subprojects-container';

      item.subProjects.forEach(subProject => {
        const subProjectCard = document.createElement('div');
        subProjectCard.className = `subproject-card ${subProject.selected ? 'selected' : ''}`;
        subProjectCard.onclick = (e) => toggleSubExpense(item.id, subProject.id, e);
        subProjectCard.style.borderLeftColor = lightenColor(item.color, 30);
        subProjectCard.style.backgroundColor = subProject.selected ? lightenColor(item.color, 95) : '#fafafa';

        subProjectCard.innerHTML = `
					<div class="project-info">
						<div class="project-name">${subProject.name}</div>
						<div class="project-amount">${formatCurrency(subProject.amount)}</div>
					</div>
					<div class="project-type">${((subProject.amount / item.amount) * 100).toFixed(2)}% от ${item.name}</div>
				`;

        subContainer.appendChild(subProjectCard);
      });
      expensesGrid.appendChild(subContainer);
    }
  });
}
// Функция для переключения раскрытия/сворачивания подстатей расходов
function toggleSubExpenses(itemId, event) {
  event.stopPropagation();

  if (expandedProjects.has(itemId)) {
    expandedProjects.delete(itemId);
  } else {
    expandedProjects.add(itemId);
  }

  renderExpenses();
}
// Функция для переключения основной статьи расходов
function toggleExpense(itemId, event) {
  if (event) event.stopPropagation();

  const item = expensesItemsData[currentExpensesYear].find(i => i.id === itemId);
  if (item) {
    item.selected = !item.selected;

    // Если статья выбрана, выбираем все ее подстатьи
    if (item.selected && item.subProjects && item.subProjects.length > 0) {
      item.subProjects.forEach(subProject => {
        subProject.selected = true;
      });
    }

    renderExpenses();
    initExpensesChart(currentExpensesChartType);
    populateExpensesTable();
    updateTotalExpenses();
  }
}
function toggleExpense(itemId) {
  if (currentTab !== 'expenses') return;
  const item = expensesItemsData[currentExpensesYear].find(i => i.id === itemId);
  if (item) {
    item.selected = !item.selected;
    renderExpenses();
    initExpensesChart(currentExpensesChartType);
    populateExpensesTable();
    updateTotalExpenses();
  }
}
// Функция для переключения подстатьи расходов
function toggleSubExpense(itemId, subProjectId, event) {
  event.stopPropagation();

  const item = expensesItemsData[currentExpensesYear].find(i => i.id === itemId);
  if (item && item.subProjects) {
    const subProject = item.subProjects.find(sp => sp.id === subProjectId);
    if (subProject) {
      subProject.selected = !subProject.selected;

      // Обновляем статус основной статьи
      updateMainExpenseSelection(item);

      renderExpenses();
      initExpensesChart(currentExpensesChartType);
      populateExpensesTable();
      updateTotalExpenses();
    }
  }
}
// Обновление статуса основной статьи на основе подстатей
function updateMainExpenseSelection(item) {
  if (item.subProjects && item.subProjects.length > 0) {
    const allSelected = item.subProjects.every(sp => sp.selected);
    const someSelected = item.subProjects.some(sp => sp.selected);

    if (allSelected) {
      item.selected = true;
    } else if (someSelected) {
      item.selected = false; // Частичный выбор
    } else {
      item.selected = false;
    }
  }
}
function populateExpensesTable() {
  const tableBody = document.getElementById('expensesTableBody');
  tableBody.innerHTML = '';

  const selectedExpenses = getSelectedExpenses();
  const selectedExpenseNames = selectedExpenses.map(i => i.name).join(', ') || 'Нет выбранных статей';
  const selectedExpensesAmount = calculateExpensesAmount();

  expensesData.years.forEach((year, index) => {
    const row = document.createElement('tr');
    const isCurrentYear = parseInt(year) === currentExpensesYear;
    const yearCell = document.createElement('td');
    yearCell.textContent = year;

    const expenseCell = document.createElement('td');
    expenseCell.textContent = formatCurrency(expensesData.expenses[index]);

    const detailsCell = document.createElement('td');

    if (isCurrentYear) {
      detailsCell.textContent = selectedExpenseNames;
      if (selectedExpenses.length > 0) {
        const br = document.createElement('br');
        const small = document.createElement('small');
        small.textContent = `Сумма: ${formatCurrency(selectedExpensesAmount)}`;
        detailsCell.appendChild(br);
        detailsCell.appendChild(small);
      }
    } else {
      detailsCell.textContent = '-';
    }
    row.appendChild(yearCell);
    row.appendChild(expenseCell);
    row.appendChild(detailsCell);
    tableBody.appendChild(row);
  });
}
// Общие функции
function changeChartType(type, tab = 'income') {
  if (tab === 'income') {
    initChart(type);
    updateButtons(type);
  } else if (tab === 'expenses') {
    initExpensesChart(type);
    updateExpensesButtons(type);
  }
}
function resetProjects(tab = 'income') {
  if (tab === 'income') {
    projectsData[currentYear].forEach(project => {
      project.selected = false;
      if (project.subProjects && project.subProjects.length > 0) {
        project.subProjects.forEach(subProject => {
          subProject.selected = false;
        });
      }
    });
    renderProjects();
    initChart(currentChartType);
    populateTable();
    updateTotalIncome();
  } else if (tab === 'expenses') {
    expensesItemsData[currentExpensesYear].forEach(item => {
      item.selected = false;
    });
    renderExpenses();
    initExpensesChart(currentExpensesChartType);
    populateExpensesTable();
    updateTotalExpenses();
  }
}

function selectAllProjects(tab = 'income') {
  if (tab === 'income') {
    projectsData[currentYear].forEach(project => {
      project.selected = true;
      if (project.subProjects && project.subProjects.length > 0) {
        project.subProjects.forEach(subProject => {
          subProject.selected = true;
        });
      }
    });
    renderProjects();
    initChart(currentChartType);
    populateTable();
    updateTotalIncome();
  } else if (tab === 'expenses') {
    expensesItemsData[currentExpensesYear].forEach(item => {
      item.selected = true;
    });
    renderExpenses();
    initExpensesChart(currentExpensesChartType);
    populateExpensesTable();
    updateTotalExpenses();
  }
}
// Вспомогательные функции
function formatCurrency(amount) {
  // Добавляем обработку отрицательных значений
  const sign = amount < 0 ? '-' : '';
  const absAmount = Math.abs(amount);
  return sign + new Intl.NumberFormat('ru-RU', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(absAmount) + ' тыс. руб.';
}

function formatCurrencyShort(amount) {
  if (amount >= 1000000) {
    return (amount / 1000000).toFixed(3) + ' млн';
  } else if (amount >= 1000) {
    return (amount / 1000).toFixed(3) + ' тыс.';
  }
  return amount.toFixed(2);
}

function darkenColor(color, percent) {
  const num = parseInt(color.replace('#', ''), 16);
  const amt = Math.round(2.55 * percent);
  const R = Math.max(0, (num >> 16) - amt);
  const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
  const B = Math.max(0, (num & 0x0000FF) - amt);
  return '#' + (
    0x1000000 +
    R * 0x10000 +
    G * 0x100 +
    B
  ).toString(16).slice(1);
}

function lightenColor(color, percent) {
  const num = parseInt(color.replace('#', ''), 16);
  const amt = Math.round(2.55 * percent);
  const R = Math.min(255, (num >> 16) + amt);
  const G = Math.min(255, (num >> 8 & 0x00FF) + amt);
  const B = Math.min(255, (num & 0x0000FF) + amt);
  return '#' + (
    0x1000000 +
    R * 0x10000 +
    G * 0x100 +
    B
  ).toString(16).slice(1);
}

function updateButtons(activeType) {
  const buttons = document.querySelectorAll('#tab-income .controls button');
  buttons.forEach(button => {
    if (button.textContent.toLowerCase().includes(activeType)) {
      button.style.opacity = '1';
      button.style.fontWeight = 'bold';
    } else {
      button.style.opacity = '0.8';
      button.style.fontWeight = 'normal';
    }
  });
}

function updateExpensesButtons(activeType) {
  const buttons = document.querySelectorAll('#tab-expenses .controls button');
  buttons.forEach(button => {
    if (button.textContent.toLowerCase().includes(activeType)) {
      button.style.opacity = '1';
      button.style.fontWeight = 'bold';
    } else {
      button.style.opacity = '0.8';
      button.style.fontWeight = 'normal';
    }
  });
}

// Добавляем CSS стили для вложенной структуры
const style = document.createElement('style');

document.head.appendChild(style);

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function () {
  if (document.getElementById('tab-projects').classList.contains('active')) {
    initProjectsChart(currentProjectsChartType);
    populateProjectsTable();
  }
  // Инициализируем доходы
  updateTotalIncome();
  initChart('bar');
  renderProjects();
  populateTable();
  updateButtons('bar');

  // Инициализируем расходы
  updateTotalExpenses();
  renderExpenses();
  populateExpensesTable();
  updateExpensesButtons('bar');

  // Предварительная инициализация проектов (но они будут скрыты)
  initProjectsChart('bar');
  populateProjectsTable();

  // Устанавливаем активные кнопки года
  document.querySelectorAll('#tab-income .year-btn').forEach(btn => {
    if (parseInt(btn.textContent) === currentYear) {
      btn.classList.add('active');
    }
  });

  document.querySelectorAll('#tab-expenses .year-btn').forEach(btn => {
    if (parseInt(btn.textContent) === currentExpensesYear) {
      btn.classList.add('active');
    }
  });
});

// Функция для экспорта данных в CSV с BOM для корректного отображения в Excel
function exportToCSV(tab = 'income') {
  let csvContent = "\uFEFF";
  let rows = [];
  // Определяем заголовки столбцов (года + Всего)
  const headers = ['Наименование', '2024', '2025', '2026', '2027', 'Всего'];
  rows.push(headers);

  if (tab === 'income') {
    // Получаем все уникальные названия проектов (включая подпроекты)
    const allProjectNames = new Set();
    financialData.years.forEach(year => {
      projectsData[year].forEach(project => {
        if (project.selected) {
          // Добавляем основной проект, если он выбран и у него нет подпроектов или они все выбраны
          if (!project.subProjects || project.subProjects.every(sp => sp.selected)) {
            allProjectNames.add(project.name);
          } else {
            // Или добавляем отдельные выбранные подпроекты
            project.subProjects.forEach(subProject => {
              if (subProject.selected) {
                allProjectNames.add(`${project.name} - ${subProject.name}`);
              }
            });
          }
        }
      });
    });

    // Для каждого уникального наименования собираем данные по годам
    allProjectNames.forEach(name => {
      const row = [name];
      let totalAmount = 0;

      financialData.years.forEach(year => {
        let amount = 0;
        const yearIndex = parseInt(year);
        // Ищем проект по имени в данных за этот год
        const project = projectsData[yearIndex].find(p =>
          p.name === name || (p.subProjects && p.subProjects.some(sp => `${p.name} - ${sp.name}` === name))
        );

        if (project) {
          if (project.subProjects && project.subProjects.some(sp => `${project.name} - ${sp.name}` === name)) {
            // Это подпроект
            const subProject = project.subProjects.find(sp => `${project.name} - ${sp.name}` === name);
            if (subProject && subProject.selected) {
              amount = subProject.amount;
            }
          } else if (project.selected) {
            // Это основной проект
            amount = project.amount;
          }
        }
        row.push(amount);
        totalAmount += amount;
      });
      row.push(totalAmount); // Добавляем сумму "Всего"
      rows.push(row);
    });
  } else if (tab === 'expenses') {
    // Получаем все уникальные названия статей расходов
    const allExpenseNames = new Set();
    expensesData.years.forEach(year => {
      expensesItemsData[year].forEach(item => {
        if (item.selected) {
          allExpenseNames.add(item.name);
        }
      });
    });

    // Для каждой статьи расходов собираем данные по годам
    allExpenseNames.forEach(name => {
      const row = [name];
      let totalAmount = 0;

      expensesData.years.forEach(year => {
        const yearIndex = parseInt(year);
        const item = expensesItemsData[yearIndex].find(i => i.name === name && i.selected);
        const amount = item ? item.amount : 0;
        row.push(amount);
        totalAmount += amount;
      });
      row.push(totalAmount); // Добавляем сумму "Всего"
      rows.push(row);
    });
  } else {
    console.warn('Неизвестная вкладка для экспорта:', tab);
    return;
  }

  // Добавляем все строки к содержимому CSV
  csvContent += rows.map(r => r.join(',')).join('\r\n'); // Используем \r\n для совместимости с Windows/Excel

  // Создаем Blob с правильной кодировкой
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

  // Создаем ссылку для скачивания
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `${tab}_data_${new Date().toISOString().slice(0, 10)}.csv`);

  // Добавляем ссылку, кликаем и удаляем
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  // Освобождаем память
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

// Функция для экспорта данных в XLSX
function exportToXLS(tab = 'income') {
  // Проверяем, загружена ли библиотека SheetJS
  if (typeof XLSX === 'undefined') {
    alert('Библиотека SheetJS не найдена. Экспорт в XLS невозможен.');
    console.error('Библиотека SheetJS не загружена.');
    return;
  }

  console.log('Библиотека XLSX загружена, начинаем экспорт...');

  let workbook = XLSX.utils.book_new();
  let worksheetData = [];
  let worksheetName = '';

  // Определяем заголовки столбцов
  const headers = ['Наименование', '2024', '2025', '2026', '2027', 'Всего'];
  worksheetData.push(headers);

  if (tab === 'income') {
    worksheetName = 'Доходы';
    // Получаем все уникальные названия проектов (включая подпроекты)
    const allProjectNames = new Set();
    financialData.years.forEach(year => {
      const yearData = projectsData[year] || [];
      yearData.forEach(project => {
        if (project.selected) {
          // Добавляем основной проект, если он выбран и у него нет подпроектов или они все выбраны
          if (!project.subProjects || project.subProjects.every(sp => sp.selected)) {
            allProjectNames.add(project.name);
          } else {
            // Или добавляем отдельные выбранные подпроекты
            project.subProjects.forEach(subProject => {
              if (subProject.selected) {
                allProjectNames.add(`${project.name} - ${subProject.name}`);
              }
            });
          }
        }
      });
    });

    // Для каждого уникального наименования собираем данные по годам
    allProjectNames.forEach(name => {
      const row = [name];
      let totalAmount = 0;

      financialData.years.forEach(year => {
        let amount = 0;
        const yearIndex = parseInt(year);
        const yearData = projectsData[yearIndex] || [];

        // Ищем проект по имени в данных за этот год
        const project = yearData.find(p =>
          p.name === name || (p.subProjects && p.subProjects.some(sp => `${p.name} - ${sp.name}` === name))
        );

        if (project) {
          if (project.subProjects && project.subProjects.some(sp => `${project.name} - ${sp.name}` === name)) {
            // Это подпроект
            const subProject = project.subProjects.find(sp => `${project.name} - ${sp.name}` === name);
            if (subProject && subProject.selected) {
              amount = subProject.amount || 0;
            }
          } else if (project.selected) {
            // Это основной проект
            amount = project.amount || 0;
          }
        }
        row.push(amount);
        totalAmount += amount;
      });
      row.push(totalAmount);
      worksheetData.push(row);
    });

  } else if (tab === 'expenses') {
    worksheetName = 'Расходы';
    // Получаем все уникальные названия статей расходов
    const allExpenseNames = new Set();
    expensesData.years.forEach(year => {
      const yearData = expensesItemsData[year] || [];
      yearData.forEach(item => {
        if (item.selected) {
          allExpenseNames.add(item.name);
        }
      });
    });

    // Для каждой статьи расходов собираем данные по годам
    allExpenseNames.forEach(name => {
      const row = [name];
      let totalAmount = 0;

      expensesData.years.forEach(year => {
        const yearIndex = parseInt(year);
        const yearData = expensesItemsData[yearIndex] || [];
        const item = yearData.find(i => i.name === name && i.selected);
        const amount = item ? (item.amount || 0) : 0;
        row.push(amount);
        totalAmount += amount;
      });
      row.push(totalAmount);
      worksheetData.push(row);
    });

  } else {
    console.warn('Неизвестная вкладка для экспорта:', tab);
    alert('Ошибка: неизвестный тип данных для экспорта');
    return;
  }

  // Добавляем строку ИТОГО в конце
  const totalRow = ['ИТОГО'];
  // Рассчитываем итоги по каждому столбцу (начиная со второго столбца)
  for (let col = 1; col < headers.length; col++) {
    let columnTotal = 0;
    for (let row = 1; row < worksheetData.length; row++) {
      columnTotal += worksheetData[row][col] || 0;
    }
    totalRow.push(columnTotal);
  }
  worksheetData.push(totalRow);

  // Создаем лист из массива данных
  let worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

  // Форматирование с xlsx-js-style
  const range = XLSX.utils.decode_range(worksheet['!ref']);

  // Форматируем заголовки (первая строка) - жирный и центрирование
  for (let col = range.s.c; col <= range.e.c; col++) {
    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
    if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's' };
    worksheet[cellAddress].s = {
      font: { bold: true, sz: 12 },
      alignment: { horizontal: 'center' },
      fill: { fgColor: { rgb: "FFE0E0E0" } } // светло-серый фон
    };
  }

  // Форматируем строку ИТОГО (последняя строка) - жирный и цветной фон
  const lastRow = worksheetData.length - 1;
  for (let col = range.s.c; col <= range.e.c; col++) {
    const cellAddress = XLSX.utils.encode_cell({ r: lastRow, c: col });
    if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's' };
    worksheet[cellAddress].s = {
      font: { bold: true, sz: 12 },
      fill: { fgColor: { rgb: "FFD4EDDA" } } // светло-зеленый фон
    };
  }

  // Форматируем ячейки с числами (денежный формат)
  for (let row = 1; row < worksheetData.length - 1; row++) {
    for (let col = 1; col < headers.length; col++) {
      const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
      if (worksheet[cellAddress] && worksheet[cellAddress].v !== undefined) {
        if (!worksheet[cellAddress].s) worksheet[cellAddress].s = {};
        worksheet[cellAddress].s.numFmt = '#,##0" ₽"';
      }
    }
  }

  // Добавляем лист в книгу
  XLSX.utils.book_append_sheet(workbook, worksheet, worksheetName);

  // Генерируем имя файла
  const fileName = `${tab === 'income' ? 'Доходы' : 'Расходы'}_${new Date().toISOString().slice(0, 10)}.xlsx`;

  // Сохраняем файл
  XLSX.writeFile(workbook, fileName);
}

// Проверяем доступность библиотеки при загрузке
document.addEventListener('DOMContentLoaded', function () {
  if (typeof XLSX !== 'undefined') {
    console.log('✅ Библиотека SheetJS успешно загружена');
  } else {
    console.error('❌ Библиотека SheetJS не загружена');
  }
});
// Функция для печати отчета с сохранением диаграмм
function printReport(tab = 'income') {
  const printContent = document.getElementById(`tab-${tab}`);
  const originalContents = document.body.innerHTML;

  // Создаем временный контейнер для печати
  const printContainer = document.createElement('div');
  printContainer.className = 'print-container';
  printContainer.style.cssText = `
				font-family: Arial, sans-serif;
				margin: 20px;
				padding: 20px;
				max-width: 800px;
				margin: 0 auto;
		`;

  // Клонируем контент
  const contentClone = printContent.cloneNode(true);
  printContainer.appendChild(contentClone);

  // Удаляем ненужные элементы
  const elementsToRemove = printContainer.querySelectorAll(
    '.year-selector, .controls, .export-buttons-small, .toggle-subprojects-btn, button, .chart-labels'
  );
  elementsToRemove.forEach(el => el.remove());

  // Добавляем заголовок
  const title = document.createElement('h2');
  title.textContent = tab === 'income' ? 'Отчет по доходам' : 'Отчет по расходам';
  title.style.textAlign = 'center';
  title.style.marginBottom = '20px';
  printContainer.insertBefore(title, printContainer.firstChild);

  // Добавляем дату
  const dateElement = document.createElement('div');
  dateElement.textContent = 'Дата формирования: ' + new Date().toLocaleDateString('ru-RU');
  dateElement.style.textAlign = 'right';
  dateElement.style.marginBottom = '20px';
  dateElement.style.color = '#666';
  printContainer.insertBefore(dateElement, printContainer.firstChild);

  // Заменяем canvas на изображения с задержкой
  setTimeout(() => {
    const canvasElements = printContainer.querySelectorAll('canvas');

    canvasElements.forEach(canvas => {
      const chartId = canvas.id;
      let chartInstance = null;

      if (chartId === 'financeChart' && currentChart) {
        chartInstance = currentChart;
      } else if (chartId === 'expensesChart' && expensesChart) {
        chartInstance = expensesChart;
      }

      if (chartInstance) {
        try {
          const imageUrl = chartInstance.toBase64Image();
          const img = document.createElement('img');
          img.src = imageUrl;
          img.style.width = '100%';
          img.style.height = '300px';
          img.style.objectFit = 'contain';
          img.alt = chartId === 'financeChart' ? 'Диаграмма доходов' : 'Диаграмма расходов';

          const container = document.createElement('div');
          container.style.margin = '20px 0';
          container.style.textAlign = 'center';
          container.appendChild(img);

          canvas.parentNode.replaceChild(container, canvas);
        } catch (error) {
          console.error('Ошибка при конвертации диаграммы:', error);
          const errorDiv = document.createElement('div');
          errorDiv.textContent = 'Диаграмма не может быть отображена';
          errorDiv.style.padding = '50px';
          errorDiv.style.textAlign = 'center';
          errorDiv.style.border = '1px dashed #ccc';
          canvas.parentNode.replaceChild(errorDiv, canvas);
        }
      } else {
        // Если диаграмма не найдена, показываем сообщение
        const noChartDiv = document.createElement('div');
        noChartDiv.textContent = 'Данные диаграммы не доступны';
        noChartDiv.style.padding = '50px';
        noChartDiv.style.textAlign = 'center';
        noChartDiv.style.border = '1px dashed #ccc';
        canvas.parentNode.replaceChild(noChartDiv, canvas);
      }
    });

    // Заменяем содержимое body и печатаем
    document.body.innerHTML = '';
    document.body.appendChild(printContainer);

    // Даем время на рендеринг изображений
    setTimeout(() => {
      window.print();

      // Восстанавливаем оригинальное содержимое
      setTimeout(() => {
        document.body.innerHTML = originalContents;

        // Переинициализируем диаграммы после восстановления
        if (currentTab === 'income') {
          initChart(currentChartType);
        } else if (currentTab === 'expenses') {
          initExpensesChart(currentExpensesChartType);
        }
      }, 100);
    }, 500);

  }, 100);
}
// Функция для инициализации диаграммы проектов
function initProjectsChart(type = 'bar') {
  const ctx = document.getElementById('projectsChart');
  if (!ctx) return;

  const ctx2d = ctx.getContext('2d');

  if (projectsChart) {
    projectsChart.destroy();
  }

  const dataByYear = {};
  const dataByCategory = {};

  // Агрегируем данные - используем totalBudget вместо budget
  initiativesData.projects.forEach(project => {
    // По годам
    if (!dataByYear[project.year]) dataByYear[project.year] = 0;
    dataByYear[project.year] += project.totalBudget;

    // По категориям (если есть категория в данных)
    if (project.category) {
      if (!dataByCategory[project.category]) dataByCategory[project.category] = 0;
      dataByCategory[project.category] += project.totalBudget;
    }
  });

  let labels, data, backgroundColor;

  switch (type) {
    case 'doughnut':
    case 'pie':
      labels = Object.keys(dataByCategory);
      data = Object.values(dataByCategory);
      backgroundColor = [
        '#4CAF50', '#2196F3', '#FF9800', '#E91E63',
        '#9C27B0', '#607D8B', '#795548', '#3F51B5'
      ];
      break;
    default: // bar chart по годам
      labels = initiativesData.years;
      data = labels.map(year => dataByYear[year] || 0);
      backgroundColor = labels.map((_, i) =>
        ['#4CAF50', '#2196F3', '#FF9800', '#E91E63'][i % 4]
      );
  }

  // Проверяем, есть ли данные для отображения
  if (data.length === 0 || data.every(val => val === 0)) {
    // Создаем placeholder, если нет данных
    projectsChart = new Chart(ctx2d, {
      type: 'bar',
      data: {
        labels: ['Нет данных'],
        datasets: [{
          label: 'Нет данных для отображения',
          data: [1],
          backgroundColor: ['#EEEEEE'],
          borderColor: ['#CCCCCC'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Нет данных для отображения диаграммы',
            font: { size: 16 }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            display: false
          },
          x: {
            display: false
          }
        }
      }
    });
    return;
  }

  projectsChart = new Chart(ctx2d, {
    type: type,
    data: {
      labels: labels,
      datasets: [{
        label: type === 'bar' ? 'Бюджет проектов по годам (тыс. руб.)' : 'Распределение по категориям',
        data: data,
        backgroundColor: backgroundColor,
        borderColor: backgroundColor.map(color => darkenColor(color, 20)),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: type === 'bar' ?
            'Бюджет инициативных проектов по годам' :
            'Распределение бюджета по категориям проектов',
          font: { size: 16 }
        },
        legend: {
          position: 'bottom'
        }
      },
      scales: type === 'bar' ? {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Бюджет (тыс. руб.)'
          },
          ticks: {
            callback: function (value) {
              return formatCurrencyShort(value);
            }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Год реализации'
          }
        }
      } : undefined
    }
  });
}

// Функция для изменения типа диаграммы проектов
function changeProjectsChartType(type) {
  currentProjectsChartType = type;
  initProjectsChart(type);
}
// Функция для заполнения таблицы проектов
function populateProjectsTable() {
  renderInitiativesTable();

  // Статистика по годам - считаем ВСЕ проекты (основные + подкатегории)
  const statsBody = document.getElementById('projectsStatsBody');
  if (!statsBody) return;

  statsBody.innerHTML = '';

  const statsByYear = {};

  // Считаем все проекты (и основные и подкатегории)
  initiativesData.projects.forEach(project => {
    // Основной проект
    if (!statsByYear[project.year]) {
      statsByYear[project.year] = {
        count: 0,
        totalBudget: 0,
        regionalTotal: 0,
        localTotal: 0,
        initiativeTotal: 0
      };
    }
    statsByYear[project.year].count++;
    statsByYear[project.year].totalBudget += project.totalBudget;
    statsByYear[project.year].regionalTotal += project.regionalBudget;
    statsByYear[project.year].localTotal += project.localBudget;
    statsByYear[project.year].initiativeTotal += project.initiativePayments;

    // Подкатегории проекта
    if (project.subProjects && project.subProjects.length > 0) {
      project.subProjects.forEach(subProject => {
        statsByYear[project.year].count++;
        statsByYear[project.year].totalBudget += subProject.amount;
        statsByYear[project.year].regionalTotal += subProject.regional;
        statsByYear[project.year].localTotal += subProject.local;
        statsByYear[project.year].initiativeTotal += subProject.initiative;
      });
    }
  });

  initiativesData.years.forEach(year => {
    if (statsByYear[year]) {
      const stats = statsByYear[year];
      const avgBudget = stats.count > 0 ? stats.totalBudget / stats.count : 0;

      const row = document.createElement('tr');
      row.innerHTML = `
				<td>${year}</td>
				<td>${stats.count}</td>
				<td>${formatCurrency(stats.totalBudget)}</td>
			`;
      statsBody.appendChild(row);
    }
  });
}

// Функции экспорта
function exportProjectsToCSV() {
  let csvContent = "\uFEFFНаименование проекта,Год,Общий бюджет,Областной бюджет,Местный бюджет,Инициативные платежи\n";

  initiativesData.projects.forEach(project => {
    csvContent += `"${project.name}",${project.year},${project.totalBudget},${project.regionalBudget},${project.localBudget},${project.initiativePayments}\n`;
  });

  downloadCSV(csvContent, 'инициативные_проекты.csv');
}

function exportProjectsToXLS() {
  if (typeof XLSX === 'undefined') {
    alert('Библиотека SheetJS не найдена');
    return;
  }

  const wsData = [
    ['Наименование проекта', 'Год', 'Бюджет (тыс. руб.)', 'Статус', 'Охват населения', 'Категория']
  ];

  initiativesData.projects.forEach(project => {
    wsData.push([
      project.name,
      project.year,
      project.budget,
      project.status,
      project.population,
      project.category
    ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, 'Инициативные проекты');
  XLSX.writeFile(wb, 'инициативные_проекты.xlsx');
}

// Функция печати отчета
function printProjectsReport() {
  const printContent = document.getElementById('tab-projects');
  const originalContents = document.body.innerHTML;

  const printContainer = document.createElement('div');
  printContainer.className = 'print-container';
  printContainer.innerHTML = printContent.innerHTML;

  // Удаляем ненужные элементы
  const elementsToRemove = printContainer.querySelectorAll('.controls, .export-buttons-small, button');
  elementsToRemove.forEach(el => el.remove());

  // Заменяем canvas на изображение
  const canvas = printContainer.querySelector('#projectsChart');
  if (canvas && projectsChart) {
    try {
      const img = document.createElement('img');
      img.src = projectsChart.toBase64Image();
      img.style.width = '100%';
      img.style.height = '300px';
      img.alt = 'Диаграмма инициативных проектов';

      const container = document.createElement('div');
      container.style.margin = '20px 0';
      container.style.textAlign = 'center';
      container.appendChild(img);

      canvas.parentNode.replaceChild(container, canvas);
    } catch (error) {
      console.error('Ошибка при конвертации диаграммы:', error);
    }
  }

  document.body.innerHTML = '';
  document.body.appendChild(printContainer);

  setTimeout(() => {
    window.print();
    document.body.innerHTML = originalContents;
    initProjectsChart(currentProjectsChartType);
  }, 500);
}

// Вспомогательная функция для скачивания CSV
function downloadCSV(content, filename) {
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

// Функция для переключения раскрытия подкатегорий
function toggleInitiativeSubProjects(projectId, event) {
  if (event) event.stopPropagation();

  if (expandedInitiatives.has(projectId)) {
    expandedInitiatives.delete(projectId);
  } else {
    expandedInitiatives.add(projectId);
  }

  renderInitiativesTable();
}

function renderInitiativesTable() {
  const tableBody = document.getElementById('projectsTableBody');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  initiativesData.projects.forEach(project => {
    const hasSubProjects = project.subProjects && project.subProjects.length > 0;
    const isExpanded = expandedInitiatives.has(project.id);

    // Основная строка проекта
    const mainRow = document.createElement('tr');
    mainRow.className = 'project-main-row';
    // Первая ячейка
    const firstCell = document.createElement('td');

    if (hasSubProjects) {
      const toggleBtn = document.createElement('button');
      toggleBtn.className = `toggle-subprojects-btn ${isExpanded ? 'expanded' : ''}`;
      toggleBtn.textContent = '►';
      toggleBtn.onclick = (e) => toggleInitiativeSubProjects(project.id, e);
      firstCell.appendChild(toggleBtn);
    } else {
      const span = document.createElement('span');
      span.className = 'no-subprojects';
      span.textContent = '•';
      firstCell.appendChild(span);
    }

    // Добавляем название проекта
    const nameText = document.createTextNode(project.name);
    firstCell.appendChild(nameText);

    // Остальные ячейки
    const yearCell = document.createElement('td');
    yearCell.textContent = project.year;

    const totalCell = document.createElement('td');
    totalCell.textContent = formatCurrency(project.totalBudget);

    const regionalCell = document.createElement('td');
    regionalCell.textContent = formatCurrency(project.regionalBudget);

    const localCell = document.createElement('td');
    localCell.textContent = formatCurrency(project.localBudget);

    const initiativeCell = document.createElement('td');
    initiativeCell.textContent = formatCurrency(project.initiativePayments);

    // Добавляем все ячейки в строку
    mainRow.appendChild(firstCell);
    mainRow.appendChild(yearCell);
    mainRow.appendChild(totalCell);
    mainRow.appendChild(regionalCell);
    mainRow.appendChild(localCell);
    mainRow.appendChild(initiativeCell);
    tableBody.appendChild(mainRow);

    // Подкатегории (если есть и проект раскрыт)
    if (hasSubProjects && isExpanded) {
      project.subProjects.forEach((subProject) => {
        const subRow = document.createElement('tr');
        subRow.className = 'project-sub-row';
        subRow.innerHTML = `
					<td class="subproject-cell">
						<span class="subproject-indent">${subProject.name}</span>
					</td>
					<td>-</td>
					<td>${formatCurrency(subProject.amount)}</td>
					<td>${formatCurrency(subProject.regional)}</td>
					<td>${formatCurrency(subProject.local)}</td>
					<td>${formatCurrency(subProject.initiative)}</td>
				`;
        tableBody.appendChild(subRow);
      });

      // Итоги по подкатегориям
      const regionalTotal = project.subProjects.reduce((sum, sp) => sum + sp.regional, 0);
      const localTotal = project.subProjects.reduce((sum, sp) => sum + sp.local, 0);
      const initiativeTotal = project.subProjects.reduce((sum, sp) => sum + sp.initiative, 0);
      const amountTotal = project.subProjects.reduce((sum, sp) => sum + sp.amount, 0);

      const totalRow = document.createElement('tr');
      totalRow.className = 'project-total-row';
      totalRow.innerHTML = `
				<td class="total-cell" colspan="2">
					<strong>Итого по подкатегориям:</strong>
				</td>
				<td><strong>${formatCurrency(amountTotal)}</strong></td>
				<td><strong>${formatCurrency(regionalTotal)}</strong></td>
				<td><strong>${formatCurrency(localTotal)}</strong></td>
				<td><strong>${formatCurrency(initiativeTotal)}</strong></td>
			`;
      tableBody.appendChild(totalRow);
    }
  });
}



// Функции для экспорта таблицы программ
function exportProgramToCSV() {
  let csvContent = "\uFEFFНаименование программы,2024,2025,2026,2027\n";

  const rows = document.querySelectorAll('.program-table tbody tr');
  rows.forEach(row => {
    if (row.classList.contains('total-row')) return; // Пропускаем итоговую строку

    const cols = row.querySelectorAll('td');
    const programName = cols[0].textContent;
    const values = Array.from(cols).slice(1).map(td => td.textContent.replace(/\s/g, ''));

    csvContent += `"${programName}",${values.join(',')}\n`;
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `муниципальные_программы_${new Date().toISOString().slice(0, 10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

function exportProgramToXLS() {
  if (typeof XLSX === 'undefined') {
    alert('Библиотека SheetJS не найдена. Экспорт в XLS невозможен.');
    return;
  }

  const wsData = [['Наименование программы', '2024', '2025', '2026', '2027']];

  const rows = document.querySelectorAll('.program-table tbody tr');
  rows.forEach(row => {
    if (row.classList.contains('total-row')) return;

    const cols = row.querySelectorAll('td');
    const programName = cols[0].textContent;
    const values = Array.from(cols).slice(1).map(td => {
      const num = parseFloat(td.textContent.replace(/\s/g, '').replace(',', '.'));
      return isNaN(num) ? td.textContent : num;
    });

    wsData.push([programName, ...values]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Муниципальные программы");
  XLSX.writeFile(wb, `муниципальные_программы_${new Date().toISOString().slice(0, 10)}.xlsx`);
}

function printProgramReport() {
  const printContent = document.getElementById('tab-budget');
  const originalContents = document.body.innerHTML;

  const printContainer = document.createElement('div');
  printContainer.className = 'print-container';
  printContainer.innerHTML = printContent.innerHTML;

  // Удаляем ненужные элементы
  const elementsToRemove = printContainer.querySelectorAll('.controls, button');
  elementsToRemove.forEach(el => el.remove());

  document.body.innerHTML = '';
  document.body.appendChild(printContainer);

  setTimeout(() => {
    window.print();
    document.body.innerHTML = originalContents;
  }, 500);
}

// Данные для детальной информации о программах
const programDetails = {
  "Развитие образования в муниципальном образовании Домбаровский район Оренбургской области": {
    goals: "Создание условий для устойчивого функционирования и развития системы образования, ее содействия социальному и экономическому развитию Новоорского района, реализации запросов личности, общества.<ul class='custom-check-list'><li>Финансовое обеспечение деятельности 17 дошкольных учреждений, возмещение расходов за присмотр и уход за детьми инвалидами, детьми сиротами и детьми.</li><li>Финансовое обеспечение деятельности 1 детского загородного лагеря «Мечта»</li><li>Организация и проведение мероприятий среди молодежи</li><li>Финансовое обеспечение деятельности учреждений дополнительного образования: -в сфере культуры-2 ДШИ, -в сфере образования, ДЦ</li><li>Организации отдыха и оздоровления детей и подростков, трудоустройство несовершеннолетних</li><li>Проведение аттестации педагогических работников</li><li>Стипендии и премии обучающимся – победителям и призерам олимпиад</li><li>Расходы на аппарат управления</li><li>Финансовое обеспечение деятельности 14 общеобразовательных учреждений</li><li>Организации отдыха и оздоровления детей и подростков, трудоустройство несовершеннолетних</li><li>Реализация безопасности образовательных учреждений</li></ul>"
  },
  "Молодое поколение муниципального образования Домбаровский район Оренбургской области": {
    goals: "Создание условий для успешной самореализации молодежи, направленной на раскрытие ее потенциала. Развитие системы патриотического воспитания молодежи. Создание условий для развития и поддержки добровольчества (волонтерства).<ul class='custom-check-list'><li>Проведение мероприятий для самореализации талантливой молодежи</li><li>Проведение мероприятий в сфере патриотического, гражданского воспитания и допризывной подготовки молодежи.</li><li>Проведение мероприятий направленных на увеличение численности добровольцев, добровольческих объединений</li></ul>"
  },
  "Стимулирование развития жилищного строительства на территории Домбаровского района Оренбургской области": {
    goals: "Предоставление социальных выплат молодым семьям на приобретение (строительство) жилья; создание долгосрочной и гарантированной системы поддержки молодых семей в решении жилищной проблемы для улучшения демографической ситуации в муниципальном образовании Новоорский район Оренбургской области.<ul class='custom-check-list'><li>За 2024 год были выданы свидетельства о праве получения социальной выплаты на приобретение (строительство) жилья 7 семьям.</li></ul>"
  },
  "Развитие муниципальной службы в муниципальном образовании Домбаровский район Оренбургской области": {
    goals: "Развитие и совершенствование муниципальной службы в муниципальном образовании, повышение эффективности деятельности органов власти муниципального образования, создание условий для повышения эффективности реализации полномочий муниципального образования Новоорский район Оренбургской области.<ul class='custom-check-list'><li>В 2024 году проводилось информирование населения вопросов освещающих деятельность органов местного самоуправления и Совета депутатов, через газету «Новоорская газета» и другие печатные СМИ, официальный сайт в сети Интернет.</li><li>Проведена диспансеризация муниципальных служащих.</li><li>Проведено 4 обучающих семинара по противодействию коррупции.</li><li>15 муниципальных служащих получили дополнительное профессиональное образование.</li></ul>"
  },
  "Экономическое развитие муниципального образования Домбаровский район Оренбургской области": {
    goals: "Поддержка и содействие развитию малого и среднего предпринимательства, создание благоприятной среды для активизации предпринимательской деятельности и решения задач социально-экономического развития района.<ul class='custom-check-list'><li>Участником программы является МАУ «МФЦ» Новоорского района, основной задачей которого является приближение услуг к населению, централизация максимального количества услуг на одной площадке, обеспечение комфортных условий их предоставления. За 2024 год учреждением предоставлено 33598 услуг, федеральных услуг 23849;региональных услуг 72; муниципальных услуг 216. Услугами портала Бизнес навигатор воспользовались 26 человека.</li></ul>"
  },
  "Управление муниципальными финансами Домбаровского района Оренбургской области": {
    goals: "Обеспечение исполнения расходных обязательств муниципального образования Домбаровский район при сохранении долгосрочной сбалансированности и устойчивости районного бюджета, повышение эффективности бюджетных расходов, совершенствование системы распределения межбюджетных трансфертов бюджетам поселений Новоорского района из бюджета	района.<ul class='custom-check-list'><li>В 2024 году результатом реализации программы является исполнение расходных обязательств за отчетный период в размере 99,2%</li><li>Отсутствие объема муниципального долга</li><li>Формирование единого информационного пространства и осуществление интеграции информационных потоков в сфере управления общественными финансами</li><li>Совершенствование бюджетного процесса на территории муниципального района</li><li>Формирование расходов районного бюджета «программным методом»</li><li>По итогам оценки открытости бюджетных данных за 2024 год	 уровень открытости бюджетных данных – очень высокий</li></ul>"
  },
  "Управление муниципальным имуществом муниципального образования Домбаровский район Оренбургской области": {
    goals: "Сохранение жилых и нежилых помещений, находящихся в муниципальной собственности муниципального образования Новоорский район, в состоянии пригодном для проживания и использования по назначению.<ul class='custom-check-list'><li>В 2024 году приобретены 9 жилых помещений и 7 жилищных сертификатов, в рамках переданных полномочий по обеспечению жилыми помещениями детей-сирот по договорам найма специализированного жилого помещения и отдельных категорий граждан по договорам социального найма, состоящих на учете в качестве нуждающихся в жилом помещении.</li></ul>"
  },
  "Защита населения и территории муниципального образования Домбаровский район Оренбургской области от чрезвычайных ситуаций, обеспечение пожарной безопасности и безопасности людей на водных объектах": {
    goals: "Повышение защищенности населения и территории Домбаровского района от чрезвычайных ситуаций природного и техногенного характера, пожаров и происшествий на водных объектах;	совершенствование системы предупреждения чрезвычайных ситуаций.<ul class='custom-check-list'><li>Повышено количества обученных в области ГО и ЧС руководящего состава муниципального звена Оренбургской территориальной подсистемы РСЧС, функциональных подсистем РСЧС, учреждений, предприятий и организаций, функционирующих на территории района.</li><li>Увеличена доля населения, обученного действиям по сигналам экстренного оповещения ГО, правилам поведения в чрезвычайных ситуациях, безопасному поведению на водных объектах от общего количества населения.</li></ul>"
  },
  "Профилактика терроризма и противодействие экстремистской деятельности на территории муниципального образования Домбаровский район Оренбургской области": {
    goals: "Реализация	государственной политики по профилактике терроризма и экстремизма, повышению уровня безопасности граждан; усиление мер по защите населения, объектов первоочередной антитеррористической защиты, расположенных на территории Новоорского района, от террористических угроз; распространение норм и установок толерантного сознания и поведения, формирование уважительного отношения к этнокультурным и конфессиональным различиям.<ul class='custom-check-list'><li>В 2024 году проведено 154 мероприятия, направленных на разъяснительную работу в учебных заведениях о противодействии идеологии терроризма;<br> - проведено 9 мероприятий, направленных на профилактику экстремизма расизма, этнической нетерпимости в молодёжной среде;<br>-размещен баннер с наглядной агитацией о повышении бдительности и действиях при угрозе возникновения чрезвычайных ситуаций и террористических актов.</li></ul>"
  },
  "Развитие сельского хозяйства и регулирование рынков сельскохозяйственной продукции, сырья и продовольствия Домбаровского района Оренбургской области": {
    goals: "Обеспечение продовольственной безопасности; повышение конкурентоспособности производимой сельскохозяйственной продукции, создание благоприятной среды для развития предпринимательства, повышения инвестиционной привлекательности отрасли; обеспечение финансовой устойчивости товаропроизводителей АПК; защита населения от болезней общих для человека и животных.<ul class='custom-check-list'><li>Проведение мероприятий по популяризации сельскохозяйственного производства.</li><li>Оказание муниципальных услуг и работ в области АПК.</li><li>Организация мероприятий при осуществлении деятельности по обращению с животными без владельцев.</li></ul>"
  },
  "Комплексные меры противодействия злоупотреблению наркотиками и их незаконному обороту в Домбаровском районе среди молодого поколения": {
    goals: "Снижение уровня наркотизации среди молодого населения Новоорского района, формирование позитивного отношения к жизни у подрастающего поколения и молодежи с помощью повышения эффективности профилактической работы, направленной на предупреждение возникновения и противодействие злоупотреблению наркотическими средствами и их незаконному обороту.<ul class='custom-check-list'><li>Проведение публичных мероприятий, направленных на профилактику наркомании среди молодых лиц в возрасте от 7 до 35 лет.</li></ul>"
  },
  "Профилактика правонарушений в муниципальном образовании Домбаровский район Оренбургской области": {
    goals: "Устранение или ослабление причин и условий, способствующих совершению правонарушений, коррекция поведения правонарушителей.<ul class='custom-check-list'><li>В 2024 году средства направлены на размещение социальной рекламы по вопросам профилактики (изготовление и размещение 1 рекламного баннера) и стимулирование деятельности народных дружинников (активное и результативное участие в охране общественного порядка).</li></ul>"
  },
  "Культура Домбаровского района Оренбургской области": {
    goals: "Программы-обеспечение условий для реализации мероприятий программы в соответствии с установленными сроками и задачами; усиление роли культуры, искусства, литературы, дополнительного образования в духовно- нравственном воспитании личности, в формировании потенциала устойчивого развития района;	поддержка деятельности социально ориентированных некоммерческих организаций (далее СОНКО) и благотворительной деятельности в целях улучшения условий и качества жизни отдельных категорий граждан.<ul class='custom-check-list'><li>Финансовое обеспечение деятельности МБУ «Центр развития культуры Домбаровского района»</li><li>Проведение районных мероприятий, на реализацию государственной национальной политики в области укрепления единства и гармонизации межнациональных отношений на территории Домбаровского района.</li><li>Создание условий для организации досуга и обеспечения жителей услугами организаций культуры.</li><li>Исполнение полномочий поселений по решению вопросов местного значения в сфере культуры , согласно заключенных соглашений с Энергетикским и Приреченским советами.</li></ul>"
  },
  "Муниципальная программа «Энергосбережение и повышение энергетической эффективности в Домбаровском районе Оренбургской области»": {
    goals: "Обеспечение рационального использования энергетических ресурсов за счет реализации энергосберегающих мероприятий, повышения энергетической эффективности в организациях бюджетной сферы.<ul class='custom-check-list'><li>Ежеквартальный мониторинг потребления энергоресурсов бюджетными образовательными учреждениями района.</li><li>Информирование населения в СМИ о методах работы и технологиях в области энергосбережения и повышения энергетической эффективности.</li></ul>"
  },
  "Укрепление общественного здоровья жителей муниципального образования Домбаровский район Оренбургской области": {
    goals: "Увеличение доли граждан, ведущих здоровый образ жизни, а также увеличение охвата населения профилактическими мероприятиями, направленными на снижение распространённости неинфекционных и инфекционных заболеваний.<ul class='custom-check-list'><li>Изготовлены и распространены среди населения буклеты «Здоровое питание, проведены спортивно- оздоровительные мероприятия».</li></ul>"
  },
  "Противодействие коррупции в муниципальном образовании Домбаровский район Оренбургской области": {
    goals: "Повышение эффективности взаимодействия органов местного самоуправления, муниципальных учреждений и граждан в сфере противодействия коррупции, создание в обществе атмосферы нетерпимости к коррупционным проявлениям.<ul class='custom-check-list'><li>За 2024 год обучено	4 муниципальных служащих по программам противодействия коррупции, размещены материалы антикоррупционной направленности в СМИ.</li></ul>"
  },
  "Повышение безопасности дорожного движения в Домбаровском районе Оренбургской области": {
    goals: "Сокращение аварийности на автотранспорте, в том числе детского дорожно – транспортного травматизма.<ul class='custom-check-list'><li>Проведение акций, профилактических мероприятий по безопасности дорожного движения, участие в областном и районном слёте юных инспекторов движения «ЮИД».</li></ul>"
  },
  "Развитие физической культуры и спорта в муниципальном образовании Домбаровский район Оренбургской области": {
    goals: "Увеличение	числа	жителей	Домбаровского района Оренбургской области, занимающихся	физической	культурой	и спортом.<ul class='custom-check-list'><li>В2024 году денежными премиями награждены	спортсмены и тренера района, добившиеся наилучших результатов в спортивно-массовой и физкультурной деятельности.</li><li>Ежегодно во всех школах района проводится тестирование уровня физической подготовки учащихся «Президентские состязания», проводится районная предметная олимпиада школьников по физической культуре. Команда района ежегодно выступает на областной предметной олимпиаде по физической культуре.</li><li>В каникулярное время во всех школах района организуется работа спортивных площадок.</li><li>Регулярно проводится работа с	призывниками, согласно спортивных нормативов.</li><li>Проводится районная военно-спортивная игра «Зарница».</li></ul>"
  },
  "Охрана окружающей среды Домбаровского района Оренбургской области": {
    goals: "Обеспечение экологической безопасности на территории Домбаровского района Оренбургской области, стабилизация и оздоровление экологической обстановки в Новоорском районе.<ul class='custom-check-list'><li>Проведение комплекса работ по контролю в области охраны окружающей среды и природопользования, направленных на выявление и ликвидацию несанкционированных свалок.</li><li>Охрана, защита и воспроизводство, а также содержание зеленных насаждений.</li><li>Формирование экологического сознания и повышение уровня экологической культуры населения.</li></ul>"
  }
};

// Функция для переключения отображения деталей программы
function toggleProgramDetails(programName, element) {
  const detailsRow = document.getElementById(`details-${programName.replace(/\s/g, '-')}`);

  if (detailsRow) {
    // Если строка с деталями уже существует, удаляем её
    detailsRow.remove();
    element.querySelector('.toggle-icon').textContent = '►';
    return;
  }

  // Создаем новую строку с деталями
  const programData = programDetails[programName];
  if (!programData) return;

  const newRow = document.createElement('tr');
  newRow.id = `details-${programName.replace(/\s/g, '-')}`;
  newRow.className = 'program-details-row';
  newRow.innerHTML = `<td colspan="5"><div class="program-details"><h4>Цели программы</h4><p>${programData.goals}</p></div></td>`;
  // Вставляем строку с деталями после текущей строки
  element.parentNode.insertBefore(newRow, element.nextSibling);
  element.querySelector('.toggle-icon').textContent = '▼';
}
// Инициализация после загрузки DOM
document.addEventListener('DOMContentLoaded', function () {
  // Добавляем кнопки раскрытия для каждой программы
  const programRows = document.querySelectorAll('.program-table tbody tr:not(.total-row)');
  programRows.forEach(row => {
    const programName = row.querySelector('td:first-child').textContent;
    if (programDetails[programName]) {
      row.querySelector('td:first-child').innerHTML =
        `<span class="toggle-icon" style="cursor:pointer; margin-right: 8px;">►</span> ${programName}`;
      row.style.cursor = 'pointer';
      row.addEventListener('click', function (e) {
        if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
          toggleProgramDetails(programName, this);
        }
      });
    }
  });
});
document.addEventListener('DOMContentLoaded', function () {
  // Функция для подсчета итогов
  function calculateTotals() {
    // Получаем все строки таблицы, кроме заголовка и итоговой строки
    const rows = document.querySelectorAll('.program-table tbody tr:not(.total-row)');
    const totals = [0, 0, 0, 0]; // Массив для сумм по каждому году
    let debugInfo = "Расчет итоговых значений:<br><br>";

    // Проходим по всем строкам и суммируем значения
    rows.forEach((row, index) => {
      const cells = row.querySelectorAll('td');
      // Проверяем, что в строке достаточно ячеек с данными
      if (cells.length >= 5) { // 1 ячейка с названием + 4 с цифрами
        debugInfo += `Строка ${index + 1}: ${cells[0].textContent.substring(0, 30)}...<br>`;

        for (let i = 1; i < 5; i++) {
          // Преобразуем текст в число (убираем пробелы и заменяем запятую на точку)
          const cellText = cells[i].textContent.replace(/\s/g, '').replace(',', '.');
          const value = parseFloat(cellText);

          if (!isNaN(value)) {
            totals[i - 1] += value;
            debugInfo += `- Год ${2023 + i}: ${cellText} -> ${value.toFixed(2)}<br>`;
          } else {
            debugInfo += `- Год ${2023 + i}: нечисловое значение (${cellText})<br>`;
          }
        }
        debugInfo += "<br>";
      }
    });

    // Обновляем значения в таблице
    document.getElementById('total-2024').textContent = formatNumber(totals[0]);
    document.getElementById('total-2025').textContent = formatNumber(totals[1]);
    document.getElementById('total-2026').textContent = formatNumber(totals[2]);
    document.getElementById('total-2027').textContent = formatNumber(totals[3]);

    // Добавляем информацию о расчетах
    debugInfo += `<strong>Итоговые суммы:</strong><br>`;
    debugInfo += `- 2024: ${formatNumber(totals[0])}<br>`;
    debugInfo += `- 2025: ${formatNumber(totals[1])}<br>`;
    debugInfo += `- 2026: ${formatNumber(totals[2])}<br>`;
    debugInfo += `- 2027: ${formatNumber(totals[3])}<br>`;
  }

  // Вспомогательная функция для форматирования чисел
  function formatNumber(num) {
    // Форматируем число с двумя знаками после запятой и пробелами тысяч
    return num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$& ');
  }

  // Вызываем функцию подсчета при загрузке страницы
  calculateTotals();
});


// Данные для детальной информации о национальных проектах
const nationalProjectDetails = {
  "НП «Образование», Региональный проект «Успех каждого ребенка»": {
    goals: "Проведение капитального ремонта и обновление материально-технической базы для занятий физической культурой и спортом МАОУ СОШ п. Кумак.<ul><li>Общая сумма 6200,0 тыс. рублей</li><li>Федеральный бюджет - 248,3 тыс. рублей</li><li>Областной бюджет - 3603,9 тыс. рублей</li><li>Районный бюджет - 2347,8 тыс. рублей</li></ul>"
  },
  "НП «Образование» Региональный проект «Патриотическое воспитание граждан Российской Федерации»": {
    goals: "Проведение мероприятий по обеспечению деятельности советников директора по воспитанию и взаимодействию с детскими общественными объединениями в общеобразовательных организациях.<ul><li>Общая сумма 2189,4 тыс. рублей</li><li>Федеральный бюджет - 2080,8 тыс. рублей</li><li>Областной бюджет - 86,7 тыс. рублей</li><li>Районный бюджет - 21,9 тыс.рублей</li></ul>"
  },
  "НП «Молодежь и дети» «Региональный проект «Педагоги и наставники»": {
    goals: "<ol><li>Обеспечение выплат ежемесячного денежного вознаграждения и проведение мероприятий по обеспечению деятельности советников директора по воспитанию и взаимодействию с детскими общественными объединениями в общеобразовательных организациях</li><li>Ежемесячное денежное вознаграждение за классное руководство педагогическим работникам государственных и муниципальных образовательных организаций, реализующих образовательные программы начального общего образования, образовательные программы основного общего образования, образовательные программы среднего общего образования</li></ol>"
  },
  "НП «Молодежь и дети» Региональный проект «Все лучшее детям»": {
    goals: "<ol><li>Реализация мероприятий по модернизации школьных систем образования</li><li>Реализация мероприятий по модернизации школьных систем образования, источником финансового обеспечения которых являются исключительно средства областного бюджета</li><li>Обеспечение в муниципальных общеобразовательных организациях, выступающих объектами капитального ремонта, требований к антитеррористической защищенности объектов (территорий)</li></ol>"
  },
};

// Функции для работы с национальными проектами
function exportNationalToCSV() {
  let csvContent = "\uFEFFНаименование национального проекта,2024,2025,2026,2027\n";

  const rows = document.querySelectorAll('#tab-schkola .program-table tbody tr');
  rows.forEach(row => {
    if (row.classList.contains('total-row')) return;

    const cols = row.querySelectorAll('td');
    const projectName = cols[0].textContent;
    const values = Array.from(cols).slice(1).map(td => td.textContent.replace(/\s/g, ''));

    csvContent += `"${projectName}",${values.join(',')}\n`;
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `национальные_проекты_${new Date().toISOString().slice(0, 10)}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

function exportNationalToXLS() {
  if (typeof XLSX === 'undefined') {
    alert('Библиотека SheetJS не найдена. Экспорт в XLS невозможен.');
    return;
  }

  const wsData = [['Наименование национального проекта', '2024', '2025', '2026', '2027']];

  const rows = document.querySelectorAll('#tab-schkola .program-table tbody tr');
  rows.forEach(row => {
    if (row.classList.contains('total-row')) return;

    const cols = row.querySelectorAll('td');
    const projectName = cols[0].textContent;
    const values = Array.from(cols).slice(1).map(td => {
      const num = parseFloat(td.textContent.replace(/\s/g, '').replace(',', '.'));
      return isNaN(num) ? td.textContent : num;
    });

    wsData.push([projectName, ...values]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Национальные проекты");
  XLSX.writeFile(wb, `национальные_проекты_${new Date().toISOString().slice(0, 10)}.xlsx`);
}

function printNationalReport() {
  const printContent = document.getElementById('tab-schkola');
  const originalContents = document.body.innerHTML;

  const printContainer = document.createElement('div');
  printContainer.className = 'print-container';
  printContainer.innerHTML = printContent.innerHTML;

  // Удаляем ненужные элементы
  const elementsToRemove = printContainer.querySelectorAll('.controls, button');
  elementsToRemove.forEach(el => el.remove());

  document.body.innerHTML = '';
  document.body.appendChild(printContainer);

  setTimeout(() => {
    window.print();
    document.body.innerHTML = originalContents;
  }, 500);
}

// Функция для подсчета итогов национальных проектов
function calculateNationalTotals() {
  const rows = document.querySelectorAll('#tab-schkola .program-table tbody tr:not(.total-row)');
  const totals = [0, 0, 0, 0];

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length >= 5) {
      for (let i = 1; i < 5; i++) {
        const cellText = cells[i].textContent.replace(/\s/g, '').replace(',', '.');
        const value = parseFloat(cellText);
        if (!isNaN(value)) {
          totals[i - 1] += value;
        }
      }
    }
  });

  // Обновляем значения в таблице
  document.getElementById('national-total-2024').textContent = formatNumber(totals[0]);
  document.getElementById('national-total-2025').textContent = formatNumber(totals[1]);
  document.getElementById('national-total-2026').textContent = formatNumber(totals[2]);
  document.getElementById('national-total-2027').textContent = formatNumber(totals[3]);
}

// Вспомогательная функция для форматирования чисел
function formatNumber(num) {
  return num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$& ');
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function () {
  // Вызываем функцию подсчета при загрузке страницы
  calculateNationalTotals();

  // Добавляем обработчики для раскрытия деталей проектов
  const projectRows = document.querySelectorAll('#tab-schkola .program-table tbody tr:not(.total-row)');
  projectRows.forEach(row => {
    const projectName = row.querySelector('td:first-child').textContent;
    if (nationalProjectDetails[projectName]) {
      row.querySelector('td:first-child').innerHTML =
        `<span class="toggle-icon" style="cursor:pointer; margin-right: 8px;">►</span> ${projectName}`;
      row.style.cursor = 'pointer';
      row.addEventListener('click', function (e) {
        if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
          toggleProjectDetails(projectName, this);
        }
      });
    }
  });
});

// Функция для переключения отображения деталей проекта
function toggleProjectDetails(projectName, element) {
  const detailsRow = document.getElementById(`national-details-${projectName.replace(/\s/g, '-')}`);

  if (detailsRow) {
    detailsRow.remove();
    element.querySelector('.toggle-icon').textContent = '►';
    return;
  }

  const projectData = nationalProjectDetails[projectName];
  if (!projectData) return;

  const newRow = document.createElement('tr');
  newRow.id = `national-details-${projectName.replace(/\s/g, '-')}`;
  newRow.className = 'program-details-row';
  newRow.innerHTML = `<td colspan="5"><div class="program-details"><h4>Цели проекта</h4><p>${projectData.goals}</p></div></td>`;
  element.parentNode.insertBefore(newRow, element.nextSibling);
  element.querySelector('.toggle-icon').textContent = '▼';
}
// Функция для проверки и получения цвета
function getColorForItem(index, year) {
  if (!projectColors[index]) {
    console.warn(`Not enough colors for year ${year}! Using default color for index ${index}`);
    return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
  }
  return projectColors[index];
}

// Функция для генерации дополнительных цветов
function generateColors(count) {
  const colors = [];
  for (let i = 0; i < count; i++) {
    const hue = (i * 137.508) % 360; // Используем золотой угол для равномерного распределения
    colors.push(`hsl(${hue}, 70%, 65%)`);
  }
  return colors;
}

// Дополняем массив цветов при необходимости
function ensureEnoughColors(requiredCount) {
  if (projectColors.length < requiredCount) {
    const additionalColors = generateColors(requiredCount - projectColors.length);
    projectColors.push(...additionalColors);
    console.log(`Added ${additionalColors.length} additional colors`);
  }
}
// Функция для безопасного вывода текста
function sanitizeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function validateDataConsistency() {
  Object.keys(expensesItemsData).forEach(year => {
    expensesItemsData[year].forEach(item => {
      if (item.subProjects && item.subProjects.length > 0) {
        const subTotal = item.subProjects.reduce((sum, sub) => sum + sub.amount, 0);
        if (Math.abs(subTotal - item.amount) > 0.1) {
          console.warn(`Несоответствие в ${year}, ${item.name}: ${item.amount} vs ${subTotal}`);
        }
      }
    });
  });
}